<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Activity Tracker">
    <meta name="theme-color" content="#C9ADA7">
    <title>üêã Activity Tracker Ultimate</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #C9ADA7 0%, #9DB4C0 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
        }
        
        /* Mobile-specific styles */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                padding-bottom: 80px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .section-title {
                font-size: 1.2em;
            }
            
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 20px auto;
                padding: 20px;
                max-height: 85vh;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .chart-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                white-space: nowrap;
                padding-bottom: 5px;
            }
            
            .chart-tab-btn {
                font-size: 0.85em;
                padding: 8px 12px;
            }
            
            .tags-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .tag-btn {
                font-size: 0.9em;
                padding: 12px;
            }
            
            .mood-btn {
                padding: 12px;
                font-size: 1.8em;
            }
            
            #moodSection {
                margin: 15px 0;
            }
            
            #moodSection > div {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .breadcrumb {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .breadcrumb-item {
                font-size: 0.85em;
                padding: 6px 10px;
            }
            
            .pie-chart-container {
                flex-direction: column;
                align-items: center;
            }
            
            .pie-chart-container svg {
                margin-bottom: 15px;
            }
            
            /* Make buttons more touch-friendly */
            .btn {
                min-height: 44px;
                padding: 12px 20px;
                font-size: 1em;
            }
            
            .app-input {
                min-height: 44px;
                font-size: 16px; /* Prevents iOS zoom */
            }
            
            textarea.app-input {
                font-size: 16px; /* Prevents iOS zoom */
            }
            
            input[type="date"] {
                min-height: 44px;
                font-size: 16px;
            }
            
            input[type="color"] {
                min-height: 44px;
                min-width: 44px;
            }
        }
        
        /* iPhone notch support */
        @supports (padding-top: env(safe-area-inset-top)) {
            body {
                padding-top: max(20px, env(safe-area-inset-top));
                padding-bottom: max(100px, env(safe-area-inset-bottom));
                padding-left: max(20px, env(safe-area-inset-left));
                padding-right: max(20px, env(safe-area-inset-right));
            }
            
            @media (max-width: 768px) {
                body {
                    padding-top: max(10px, env(safe-area-inset-top));
                    padding-left: max(10px, env(safe-area-inset-left));
                    padding-right: max(10px, env(safe-area-inset-right));
                }
            }
        }
        
        /* Prevent pull-to-refresh on iOS */
        body {
            overscroll-behavior-y: contain;
        }
        
        /* Better scrolling on iOS */
        .modal-content,
        .card {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Smooth scroll */
        html {
            scroll-behavior: smooth;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .date-navigator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.3);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .current-date {
            background: rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .view-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .current-activity {
            text-align: center;
        }

        .timer {
            font-size: 3em;
            font-weight: bold;
            color: #B5838D;
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
        }

        .activity-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tag-badge {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .app-badge {
            padding: 8px 20px;
            background: #f0f0f0;
            border-radius: 20px;
            font-size: 1em;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            padding: 6px 12px;
            background: #f0f0f0;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .breadcrumb-item:hover {
            background: #e0e0e0;
        }

        .breadcrumb-item.active {
            background: #B5838D;
            color: white;
        }

        .breadcrumb-separator {
            color: #999;
        }

        .tags-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .tag-btn {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            font-weight: 600;
            text-align: center;
            position: relative;
        }

        .tag-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .tag-btn.selected {
            border-color: currentColor;
            background: currentColor;
            color: white;
        }

        .tag-btn.has-children::after {
            content: '‚Ä∫';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5em;
            opacity: 0.5;
        }

        .app-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1em;
            margin-bottom: 15px;
        }

        .app-input:focus {
            outline: none;
            border-color: #C9ADA7;
        }

        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #C9ADA7;
            color: white;
        }

        .btn-primary:hover {
            background: #B5838D;
            transform: translateY(-2px);
        }

        .btn-stop {
            background: #ef4444;
            color: white;
        }

        .btn-stop:hover {
            background: #dc2626;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            padding: 20px;
            background: linear-gradient(135deg, #E0BBE4 0%, #C7CEEA 100%);
            border-radius: 12px;
            color: white;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .chart-tab-btn {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .chart-tab-btn.active {
            background: #B5838D;
            color: white;
        }

        .chart-tab-btn:hover:not(.active) {
            background: #e0e0e0;
        }

        .chart-container {
            margin-top: 20px;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        /* Sunburst Chart */
        .sunburst-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
            position: relative;
        }

        .sunburst-svg {
            cursor: pointer;
        }

        .sunburst-arc {
            transition: opacity 0.3s;
        }

        .sunburst-arc:hover {
            opacity: 0.8;
        }

        .sunburst-legend {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        /* Simple Pie Chart */
        .pie-chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        /* Timeline */
        .timeline-container {
            position: relative;
            height: 600px;
            margin: 20px 0;
            border-left: 2px solid #e0e0e0;
            padding-left: 70px;
        }

        .timeline-hours {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 60px;
        }

        .hour-marker {
            position: absolute;
            right: 10px;
            font-size: 0.75em;
            color: #666;
            transform: translateY(-50%);
        }

        .timeline-grid {
            position: relative;
            height: 100%;
        }

        .timeline-hour-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background: #f0f0f0;
        }

        .timeline-block {
            position: absolute;
            left: 0;
            right: 0;
            border-radius: 8px;
            padding: 10px;
            font-size: 0.85em;
            color: white;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .timeline-block:hover {
            opacity: 0.9;
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Heatmap */
        .heatmap-wrapper {
            margin: 20px 0;
        }

        .heatmap-grid {
            display: grid;
            gap: 8px;
            margin: 20px 0;
        }

        .heatmap-grid.week {
            grid-template-columns: repeat(7, 1fr);
        }

        .heatmap-grid.month {
            grid-template-columns: repeat(7, 1fr);
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .heatmap-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .heatmap-day {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .heatmap-time {
            font-size: 0.75em;
            opacity: 0.9;
        }

        /* Trend Chart */
        .trend-container {
            position: relative;
            height: 300px;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .trend-svg {
            width: 100%;
            height: 100%;
        }

        .trend-line {
            fill: none;
            stroke: #C9ADA7;
            stroke-width: 3;
            stroke-linejoin: round;
            stroke-linecap: round;
        }

        .trend-point {
            fill: white;
            stroke: #B5838D;
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.3s;
        }

        .trend-point:hover {
            r: 8;
            fill: #B5838D;
        }

        .trend-grid-line {
            stroke: #e0e0e0;
            stroke-width: 1;
            stroke-dasharray: 5,5;
        }

        .trend-axis {
            stroke: #999;
            stroke-width: 1;
        }

        .trend-label {
            font-size: 0.8em;
            fill: #666;
        }

        /* Bar Chart */
        .chart-bar {
            margin-bottom: 15px;
        }

        .chart-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .chart-bar-bg {
            height: 30px;
            background: #f0f0f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .chart-bar-fill {
            height: 100%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            padding: 0 10px;
            color: white;
            font-weight: 600;
            font-size: 0.85em;
        }

        .quick-apps {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .quick-app-btn {
            padding: 10px 15px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .quick-app-btn:hover {
            background: #e0e0e0;
        }

        .manage-tags-btn {
            background: #f0f0f0;
            margin-top: 10px;
        }

        .export-btn {
            background: #10b981;
            color: white;
            margin-top: 10px;
        }

        .export-btn:hover {
            background: #059669;
        }

        .activities-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-details {
            flex: 1;
        }

        .activity-time {
            font-weight: 600;
            color: #B5838D;
        }

        .activity-duration {
            font-size: 0.9em;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .tag-manager-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 10px;
        }

        .tag-manager-item-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .tag-actions {
            display: flex;
            gap: 8px;
        }

        .add-child-btn {
            padding: 6px 12px;
            background: #C9ADA7;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .delete-btn {
            padding: 6px 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .mood-btn {
            padding: 15px;
            font-size: 2em;
            border: 3px solid #f0f0f0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mood-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .mood-btn.selected {
            border-color: #C9ADA7;
            background: #FFF5F5;
            transform: scale(1.1);
        }

        textarea.app-input {
            min-height: 80px;
        }

        .mood-breakdown-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .mood-breakdown-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mood-activity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .mood-activity-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid;
            font-size: 0.9em;
        }

        .mood-activity-item strong {
            display: block;
            margin-bottom: 4px;
        }

        .color-picker {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .color-option.selected {
            border-color: #333;
            transform: scale(1.1);
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.5em;
            }
            .timer {
                font-size: 2.5em;
            }
            .tags-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .timeline-container {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- iOS Install Prompt -->
        <div id="installPrompt" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
            <div style="font-size: 1.1em; font-weight: 600; margin-bottom: 8px;">üì± Install this app!</div>
            <div style="font-size: 0.9em; margin-bottom: 12px;">
                Tap <strong>Share</strong> <span style="font-size: 1.3em;">‚¨ÜÔ∏è</span> then <strong>"Add to Home Screen"</strong>
            </div>
            <button onclick="closeInstallPrompt()" style="background: white; color: #667eea; border: none; padding: 8px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Got it!
            </button>
        </div>

        <div class="header">
            <h1>üêã Activity Tracker Ultimate</h1>
            
            <div class="date-navigator">
                <button class="nav-btn" onclick="changeDate(-1)">‚Üê Previous</button>
                <div class="current-date" id="displayDate"></div>
                <button class="nav-btn" onclick="changeDate(1)" id="nextBtn">Next ‚Üí</button>
            </div>

            <div class="view-tabs">
                <button class="tab-btn active" onclick="switchMainView('daily')">Daily</button>
                <button class="tab-btn" onclick="switchMainView('weekly')">Weekly</button>
                <button class="tab-btn" onclick="switchMainView('monthly')">Monthly</button>
            </div>
        </div>

        <!-- Daily View -->
        <div id="dailyView">
            <!-- Current Activity Card -->
            <div class="card current-activity" id="trackingCard" style="display: none;">
                <h2 class="section-title">Currently Tracking</h2>
                <div class="timer" id="timer">00:00:00</div>
                <div class="activity-info">
                    <div class="tag-badge" id="currentTag"></div>
                    <div class="app-badge" id="currentApp"></div>
                </div>
                
                <!-- Mood Selection (shown when ready to stop) -->
                <div id="moodSection" style="display: none; margin: 20px 0;">
                    <h3 style="font-size: 1.1em; margin-bottom: 15px; color: #666;">How did it feel? ÊÑüËßâÊÄé‰πàÊ†∑Ôºü</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px;">
                        <button class="mood-btn" onclick="selectMood('üòä', 'Happy')" title="Happy">üòä</button>
                        <button class="mood-btn" onclick="selectMood('üòå', 'Calm')" title="Calm">üòå</button>
                        <button class="mood-btn" onclick="selectMood('ü§î', 'Focused')" title="Focused">ü§î</button>
                        <button class="mood-btn" onclick="selectMood('üò´', 'Tired')" title="Tired">üò´</button>
                        <button class="mood-btn" onclick="selectMood('üò§', 'Frustrated')" title="Frustrated">üò§</button>
                        <button class="mood-btn" onclick="selectMood('üòÑ', 'Excited')" title="Excited">üòÑ</button>
                        <button class="mood-btn" onclick="selectMood('üòê', 'Neutral')" title="Neutral">üòê</button>
                        <button class="mood-btn" onclick="selectMood('üí™', 'Productive')" title="Productive">üí™</button>
                        <button class="mood-btn" onclick="selectMood('üò©', 'Stressed')" title="Stressed">üò©</button>
                        <button class="mood-btn" onclick="selectMood('ü•±', 'Bored')" title="Bored">ü•±</button>
                        <button class="mood-btn" onclick="selectMood('üòé', 'Confident')" title="Confident">üòé</button>
                        <button class="mood-btn" onclick="selectMood('ü§ó', 'Satisfied')" title="Satisfied">ü§ó</button>
                        <button class="mood-btn" onclick="selectMood('üò∞', 'Anxious')" title="Anxious">üò∞</button>
                        <button class="mood-btn" onclick="selectMood('üôÇ', 'Content')" title="Content">üôÇ</button>
                        <button class="mood-btn" onclick="selectMood('üòÆ‚Äçüí®', 'Relieved')" title="Relieved">üòÆ‚Äçüí®</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #666;">
                            Note (optional) Â§áÊ≥®ÔºàÂèØÈÄâÔºâ
                        </label>
                        <textarea 
                            id="moodNote" 
                            class="app-input" 
                            placeholder="How do you feel about this activity? ‰Ω†ÂØπËøô‰∏™Ê¥ªÂä®ÁöÑÊÑüÂèó..."
                            rows="3"
                            style="resize: vertical; font-family: inherit;"
                        ></textarea>
                    </div>
                </div>
                
                <button class="btn btn-stop" onclick="showMoodSection()">Stop Tracking</button>
                <button class="btn btn-primary" id="confirmStopBtn" style="display: none; margin-top: 10px;" onclick="confirmStopTracking()">
                    ‚úì Confirm & Save
                </button>
            </div>

            <!-- Start New Activity Card -->
            <div class="card" id="startCard">
                <h2 class="section-title">What are you doing?</h2>
                
                <div style="background: #f0f8ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #9DB4C0;">
                    <div style="font-size: 0.9em; color: #666;">
                        üí° <strong>6-Level Tags Supported!</strong> ‰æãÂ¶ÇÔºö<br>
                        Work ‚Ä∫ ÂÜô‰Ωú ‚Ä∫ Â∞èËØ¥ ‚Ä∫ ÁßëÂπª ‚Ä∫ ÈïøÁØá ‚Ä∫ Á¨¨‰∏ÄÈÉ®
                    </div>
                </div>
                
                <div class="breadcrumb" id="tagBreadcrumb"></div>
                <div class="tags-grid" id="tagsGrid"></div>
                
                <button class="btn manage-tags-btn" onclick="openTagManager()">+ Manage Tags</button>

                <div style="margin-top: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Which app?</label>
                    <div class="quick-apps" id="quickApps"></div>
                    <input type="text" class="app-input" id="appInput" placeholder="Type app name...">
                </div>

                <button class="btn btn-primary" onclick="startTracking()">Start Tracking</button>
            </div>

            <!-- Charts Card -->
            <div class="card">
                <h2 class="section-title">Analytics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Time</div>
                        <div class="stat-value" id="totalTime">0h 0m</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Activities</div>
                        <div class="stat-value" id="totalActivities">0</div>
                    </div>
                </div>

                <div class="chart-tabs">
                    <button class="chart-tab-btn active" onclick="switchChartType('bar')">üìä Bar Chart</button>
                    <button class="chart-tab-btn" onclick="switchChartType('pie')">ü•ß Pie Chart</button>
                    <button class="chart-tab-btn" onclick="switchChartType('sunburst')">‚òÄÔ∏è Sunburst</button>
                    <button class="chart-tab-btn" onclick="switchChartType('timeline')">‚è∞ Timeline</button>
                    <button class="chart-tab-btn" onclick="switchChartType('trend')">üìà Trend</button>
                    <button class="chart-tab-btn" onclick="switchChartType('mood')">üòä Mood</button>
                </div>

                <!-- Bar Chart View -->
                <div id="barChartView">
                    <h3 style="margin-top: 20px; margin-bottom: 15px;">Time by Tag</h3>
                    <div class="chart-container" id="tagBarChart"></div>
                    <h3 style="margin-top: 20px; margin-bottom: 15px;">Time by App</h3>
                    <div class="chart-container" id="appBarChart"></div>
                    <h3 style="margin-top: 20px; margin-bottom: 15px;">Time by Device</h3>
                    <div class="chart-container" id="deviceBarChart"></div>
                </div>

                <!-- Pie Chart View -->
                <div id="pieChartView" style="display: none;">
                    <h3 style="margin-top: 20px; margin-bottom: 15px;">Time Distribution by Tag</h3>
                    <div id="tagPieChart"></div>
                    <h3 style="margin-top: 20px; margin-bottom: 15px;">Time Distribution by App</h3>
                    <div id="appPieChart"></div>
                    <h3 style="margin-top: 20px; margin-bottom: 15px;">Time Distribution by Device</h3>
                    <div id="devicePieChart"></div>
                    <h3 style="margin-top: 20px; margin-bottom: 15px;">Mood Distribution ÂøÉÊÉÖÂàÜÂ∏É</h3>
                    <div id="moodPieChart"></div>
                </div>

                <!-- Sunburst Chart View -->
                <div id="sunburstView" style="display: none;">
                    <h3 style="margin-top: 20px; margin-bottom: 15px;">Hierarchical Time Distribution</h3>
                    <div class="sunburst-container" id="sunburstChart"></div>
                    <div class="sunburst-legend" id="sunburstLegend"></div>
                </div>

                <!-- Timeline View -->
                <div id="timelineView" style="display: none;">
                    <h3 style="margin-top: 20px; margin-bottom: 15px;">Daily Timeline (24 Hours)</h3>
                    <div class="timeline-container" id="dailyTimeline"></div>
                </div>

                <!-- Trend View -->
                <div id="trendView" style="display: none;">
                    <h3 style="margin-top: 20px; margin-bottom: 15px;">7-Day Trend</h3>
                    <div class="trend-container" id="trendChart"></div>
                </div>

                <!-- Mood View -->
                <div id="moodView" style="display: none;">
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px;">
                        <button class="btn" style="background: #9DB4C0; color: white;" onclick="openDateCompare()">
                            üìÖ Compare Dates
                        </button>
                        <button class="btn" style="background: #E0BBE4; color: white;" onclick="openColorCustom()">
                            üé® Customize Colors
                        </button>
                        <button class="btn" style="background: #BAFFC9; color: white;" onclick="exportPieChart()">
                            üíæ Export Chart
                        </button>
                    </div>
                    
                    <h3 style="margin-top: 20px; margin-bottom: 15px;">üòä Mood Statistics ÂøÉÊÉÖÁªüËÆ°</h3>
                    <div id="moodStatsCards"></div>
                    
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">Mood-Activity Relationship ÂøÉÊÉÖ‚ÜíÊ¥ªÂä®ÂÖ≥Á≥ª</h3>
                    <p style="color: #666; margin-bottom: 15px; text-align: center;">ÊØèÁßçÂøÉÊÉÖ‰∏ãÂÅö‰∫Ü‰ªÄ‰πàÊ¥ªÂä®ÔºàÂ≠ó‰ΩìÂ§ßÂ∞è = Ê¥ªÂä®Êó∂ÈïøÔºâ</p>
                    <div id="moodActivityPieChart" style="display: flex; justify-content: center; align-items: center; min-height: 600px;"></div>
                    
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">Activity-Mood Relationship Ê¥ªÂä®‚ÜíÂøÉÊÉÖÂÖ≥Á≥ª</h3>
                    <p style="color: #666; margin-bottom: 15px; text-align: center;">ÊØè‰∏™Ê¥ªÂä®Áî®‰ªÄ‰πàÂøÉÊÉÖÂÆåÊàêÔºàÂ≠ó‰ΩìÂ§ßÂ∞è = HappyÂç†ÊØîÔºâ</p>
                    <div id="activityMoodPieChart" style="display: flex; justify-content: center; align-items: center; min-height: 600px;"></div>
                    
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">Mood Distribution ÂøÉÊÉÖÂàÜÂ∏É</h3>
                    <div class="chart-container" id="moodDistChart"></div>
                    
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">Mood by Activity Ê¥ªÂä®‰∏éÂøÉÊÉÖ</h3>
                    <div id="moodByActivityChart"></div>
                    
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">Top Activities per Mood ÂêÑÂøÉÊÉÖÁöÑ‰∏ªË¶ÅÊ¥ªÂä®</h3>
                    <div id="moodActivityBreakdownChart"></div>
                </div>
            </div>

            <!-- Activities List Card -->
            <div class="card">
                <h2 class="section-title">Today's Activities</h2>
                <div class="activities-list" id="activitiesList"></div>
            </div>
        </div>

        <!-- Weekly View -->
        <div id="weeklyView" style="display: none;">
            <div class="card">
                <h2 class="section-title">Week Overview</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Weekly Total</div>
                        <div class="stat-value" id="weeklyTotal">0h 0m</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Daily Average</div>
                        <div class="stat-value" id="dailyAvg">0h 0m</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Week Heatmap</h3>
                <div class="heatmap-wrapper">
                    <div class="heatmap-grid week" id="weekHeatmap"></div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Weekly Trend</h3>
                <div class="trend-container" id="weeklyTrendChart"></div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Week by Tag</h3>
                <div class="chart-container" id="weeklyTagChart"></div>
            </div>
        </div>

        <!-- Monthly View -->
        <div id="monthlyView" style="display: none;">
            <div class="card">
                <h2 class="section-title">Month Overview</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Monthly Total</div>
                        <div class="stat-value" id="monthlyTotal">0h 0m</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Active Days</div>
                        <div class="stat-value" id="activeDays">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Daily Average</div>
                        <div class="stat-value" id="monthlyAvg">0h 0m</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Month Heatmap</h3>
                <div class="heatmap-wrapper">
                    <div class="heatmap-grid month" id="monthHeatmap"></div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Monthly Trend</h3>
                <div class="trend-container" id="monthlyTrendChart"></div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Month by Tag</h3>
                <div class="chart-container" id="monthlyTagChart"></div>
            </div>
        </div>

        <!-- Device Settings Card -->
        <div class="card">
            <h2 class="section-title">Device Settings</h2>
            <p style="color: #666; margin-bottom: 15px;">
                Current device: <strong id="currentDeviceDisplay"></strong>
            </p>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Custom Device Name (Optional)</label>
                <input type="text" class="app-input" id="deviceNameInput" placeholder="e.g., Work Mac, Personal iPhone">
            </div>
            <button class="btn" style="background: #C9ADA7; color: white;" onclick="updateDeviceName()">
                Save Device Name
            </button>
        </div>

        <!-- Export/Import Data Card -->
        <div class="card">
            <h2 class="section-title">Data Management</h2>
            <p style="color: #666; margin-bottom: 15px; line-height: 1.6;">
                Export your data to sync between devices. Import will <strong>merge</strong> activities - if you tracked 1 hour on iPhone and 1 hour on Mac for the same day, the total will be 2 hours.
            </p>
            <button class="btn export-btn" onclick="exportData()">üì§ Export Data as CSV</button>
            <div style="margin-top: 15px;">
                <input type="file" id="importFile" accept=".csv" style="display: none;" onchange="importData(event)">
                <button class="btn" style="background: #9DB4C0; color: white;" onclick="document.getElementById('importFile').click()">
                    üì• Import & Merge Data from CSV
                </button>
            </div>
            <div id="importStatus" style="margin-top: 15px; padding: 10px; border-radius: 8px; display: none;"></div>
        </div>
    </div>

    <!-- Tag Manager Modal -->
    <div class="modal" id="tagModal">
        <div class="modal-content">
            <h2 class="section-title">Manage Tags</h2>
            
            <div style="background: #f0f8ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #9DB4C0;">
                <div style="font-size: 0.9em; color: #666;">
                    ‚ú® <strong>Create up to 6 levels of tags!</strong><br>
                    Click "+ Sub" to add child tags at any level<br>
                    Example: Work ‚Ä∫ Writing ‚Ä∫ Novel ‚Ä∫ Sci-Fi ‚Ä∫ Series ‚Ä∫ Book 1
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <input type="text" class="app-input" id="newTagName" placeholder="New tag name...">
                <div class="color-picker" id="colorPicker"></div>
                <button class="btn btn-primary" onclick="addNewTag()">Add Tag</button>
            </div>

            <h3 style="margin-bottom: 15px;">Current Tags</h3>
            <div id="tagsList"></div>

            <button class="btn" style="margin-top: 20px; background: #f0f0f0;" onclick="closeTagManager()">Close</button>
        </div>
    </div>

    <!-- Pie Chart Detail Modal -->
    <div class="modal" id="pieDetailModal">
        <div class="modal-content">
            <h2 class="section-title" id="pieDetailTitle"></h2>
            <div id="pieDetailContent"></div>
            <button class="btn" style="margin-top: 20px; background: #f0f0f0;" onclick="closePieDetail()">Close</button>
        </div>
    </div>

    <!-- Date Comparison Modal -->
    <div class="modal" id="dateCompareModal">
        <div class="modal-content" style="max-width: 900px;">
            <h2 class="section-title">üìÖ Compare Mood Charts Across Dates</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Date 1:</label>
                    <input type="date" class="app-input" id="compareDate1" onchange="updateComparison()">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Date 2:</label>
                    <input type="date" class="app-input" id="compareDate2" onchange="updateComparison()">
                </div>
            </div>
            
            <div id="comparisonCharts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <!-- Comparison charts will be inserted here -->
            </div>
            
            <button class="btn" style="margin-top: 20px; background: #f0f0f0;" onclick="closeDateCompare()">Close</button>
        </div>
    </div>

    <!-- Color Customization Modal -->
    <div class="modal" id="colorCustomModal">
        <div class="modal-content">
            <h2 class="section-title">üé® Customize Chart Colors</h2>
            
            <h3 style="margin-bottom: 15px;">Mood Colors</h3>
            <div id="moodColorCustomizer"></div>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveColorCustomization()">Save Colors</button>
                <button class="btn" style="margin-left: 10px; background: #f0f0f0;" onclick="resetColors()">Reset to Default</button>
            </div>
            
            <button class="btn" style="margin-top: 20px; background: #f0f0f0;" onclick="closeColorCustom()">Close</button>
        </div>
    </div>

    <script>
        // Configuration
        const defaultTags = [
            { id: '1', name: 'Work', color: '#B5838D', children: [] },        // Dusty Rose
            { id: '2', name: 'Study', color: '#9DB4C0', children: [] },       // Dusty Blue
            { id: '3', name: 'Fun', color: '#FFB3BA', children: [] },         // Pastel Pink
            { id: '4', name: 'Exercise', color: '#BAFFC9', children: [] },    // Pastel Mint
            { id: '5', name: 'Sleep', color: '#C7CEEA', children: [] },       // Pastel Periwinkle
            { id: '6', name: 'Investing', color: '#FFDFBA', children: [] }    // Pastel Peach
        ];

        const commonApps = ['Safari', 'Chrome', 'YouTube', 'TikTok', 'Spotify', 'Books', 'Kindle', 'Notes', 'Mail', 'Slack'];
        
        const colorOptions = ['#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF', '#E0BBE4', '#FFDFD3', '#C7CEEA', '#B5838D', '#C8B8A8', '#A8BFA8', '#9DB4C0', '#C9ADA7', '#A5A58D', '#B7B7A4', '#DFD7C7', '#E8C1C5', '#C5E0DC', '#F0E5CF', '#D4C5E2', '#FFE5D9', '#C9E4DE', '#F7D9C4', '#E2D1F9', '#D4A5A5', '#A7C4BC', '#E5B8B8', '#B8C9D4', '#D9C5B2', '#C5D8A7'];

        // State
        let tags = [];
        let allActivities = [];
        let currentActivity = null;
        let timerInterval = null;
        let selectedTagPath = [];
        let selectedColor = colorOptions[0];
        let currentViewDate = new Date();
        let currentMainView = 'daily';
        let currentChartType = 'bar';
        let nextTagId = 100;
        let deviceName = '';
        let deviceType = '';
        let selectedMood = null;
        let selectedMoodEmoji = null;
        
        // Custom mood colors (can be overridden by user)
        let customMoodColors = null;
        
        function getMoodColors() {
            if (customMoodColors) return customMoodColors;
            
            return {
                'Happy': '#FFB3BA', 'Calm': '#C7CEEA', 'Focused': '#9DB4C0', 'Tired': '#B5838D',
                'Frustrated': '#E5B8B8', 'Excited': '#FFDFBA', 'Neutral': '#B7B7A4', 'Productive': '#BAFFC9',
                'Stressed': '#D4A5A5', 'Bored': '#DFD7C7', 'Confident': '#BAE1FF', 'Satisfied': '#E0BBE4',
                'Anxious': '#C9ADA7', 'Content': '#F0E5CF', 'Relieved': '#C5E0DC'
            };
        }

        function showMoodSection() {
            document.querySelector('.btn-stop').style.display = 'none';
            document.getElementById('moodSection').style.display = 'block';
            document.getElementById('confirmStopBtn').style.display = 'block';
        }

        function selectMood(emoji, mood) {
            selectedMoodEmoji = emoji;
            selectedMood = mood;
            
            console.log('Selected mood:', mood, emoji);
            
            // Update button styles
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Find and highlight the clicked button
            const buttons = document.querySelectorAll('.mood-btn');
            buttons.forEach(btn => {
                const onclickStr = btn.getAttribute('onclick');
                if (onclickStr && onclickStr.includes(`'${emoji}'`) && onclickStr.includes(`'${mood}'`)) {
                    btn.classList.add('selected');
                }
            });
        }

        function confirmStopTracking() {
            const moodNote = document.getElementById('moodNote').value.trim();
            
            if (!selectedMoodEmoji) {
                alert('Please select a mood emoji! ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÂøÉÊÉÖË°®ÊÉÖÔºÅ');
                return;
            }
            
            console.log('Confirming stop with mood:', selectedMood, selectedMoodEmoji);
            stopTracking(selectedMoodEmoji, selectedMood, moodNote);
        }

        function stopTracking(moodEmoji, mood, note) {
            if (!currentActivity) {
                console.error('No current activity to stop!');
                return;
            }

            const endTime = new Date().toISOString();
            const activity = {
                ...currentActivity,
                end: endTime,
                duration: new Date(endTime) - new Date(currentActivity.start)
            };
            
            // Explicitly set mood data
            if (moodEmoji && mood) {
                activity.mood = mood;
                activity.moodEmoji = moodEmoji;
                activity.note = note || '';
                console.log('Setting mood data:', { mood, moodEmoji, note });
            } else {
                activity.mood = null;
                activity.moodEmoji = null;
                activity.note = '';
                console.warn('No mood data provided');
            }

            console.log('Final activity object:', activity);
            allActivities.push(activity);
            console.log('Total activities after push:', allActivities.length);
            console.log('Activities with mood:', allActivities.filter(a => a.mood && a.moodEmoji).length);
            
            currentActivity = null;
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            saveData();
            console.log('Data saved to localStorage');
            
            // Reset mood section
            document.getElementById('moodSection').style.display = 'none';
            document.getElementById('confirmStopBtn').style.display = 'none';
            document.querySelector('.btn-stop').style.display = 'block';
            document.getElementById('moodNote').value = '';
            document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('selected'));
            selectedMood = null;
            selectedMoodEmoji = null;
            
            document.getElementById('trackingCard').style.display = 'none';
            document.getElementById('startCard').style.display = 'block';
            document.getElementById('appInput').value = '';
            window.selectedTagInfo = null;
            selectedTagPath = [];
            renderTagHierarchy();
            
            renderCurrentView();
        }

        function getDeviceIcon(deviceType) {
            const icons = {
                'iPhone': 'üì±',
                'iPad': 'üì±',
                'Mac': 'üíª',
                'Android': 'üì±',
                'Desktop': 'üñ•Ô∏è'
            };
            return icons[deviceType] || 'üì±';
        }

        function getDeviceColor(deviceType) {
            const colors = {
                'iPhone': '#000000',
                'iPad': '#5856d6',
                'Mac': '#007aff',
                'Android': '#34c759',
                'Desktop': '#ff9500'
            };
            return colors[deviceType] || '#8e8e93';
        }

        function detectDevice() {
            const ua = navigator.userAgent;
            if (/iPad/.test(ua)) {
                deviceType = 'iPad';
            } else if (/iPhone/.test(ua)) {
                deviceType = 'iPhone';
            } else if (/Macintosh/.test(ua)) {
                deviceType = 'Mac';
            } else if (/Android/.test(ua)) {
                deviceType = 'Android';
            } else {
                deviceType = 'Desktop';
            }
            
            // Load custom device name if exists
            const savedName = localStorage.getItem('deviceName');
            if (savedName) {
                deviceName = savedName;
            } else {
                deviceName = deviceType;
            }
        }

        // Initialize
        function init() {
            detectDevice();
            loadData();
            updateDateDisplay();
            renderTagHierarchy();
            renderQuickApps();
            renderCurrentView();
            updateDeviceDisplay();
            checkInstallPrompt();
        }

        function checkInstallPrompt() {
            // Check if running in standalone mode (already installed)
            const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
            
            // Check if user has already dismissed the prompt
            const promptDismissed = localStorage.getItem('installPromptDismissed');
            
            // Show prompt only on iOS/iPadOS, not in standalone, and not dismissed
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            if (isIOS && !isStandalone && !promptDismissed) {
                document.getElementById('installPrompt').style.display = 'block';
            }
        }

        function closeInstallPrompt() {
            document.getElementById('installPrompt').style.display = 'none';
            localStorage.setItem('installPromptDismissed', 'true');
        }

        function updateDeviceDisplay() {
            document.getElementById('currentDeviceDisplay').textContent = `${getDeviceIcon(deviceType)} ${deviceName}`;
            document.getElementById('deviceNameInput').value = deviceName === deviceType ? '' : deviceName;
        }

        function updateDeviceName() {
            const newName = document.getElementById('deviceNameInput').value.trim();
            if (newName) {
                deviceName = newName;
            } else {
                deviceName = deviceType;
            }
            localStorage.setItem('deviceName', deviceName);
            updateDeviceDisplay();
            alert(`Device name updated to: ${deviceName}`);
        }

        function loadData() {
            const savedTags = localStorage.getItem('activityTagsV2');
            if (savedTags) {
                tags = JSON.parse(savedTags);
                const findMaxId = (tagList) => {
                    let max = 0;
                    tagList.forEach(tag => {
                        const id = parseInt(tag.id);
                        if (id > max) max = id;
                        if (tag.children && tag.children.length > 0) {
                            const childMax = findMaxId(tag.children);
                            if (childMax > max) max = childMax;
                        }
                    });
                    return max;
                };
                nextTagId = findMaxId(tags) + 1;
            } else {
                tags = defaultTags;
            }

            const savedActivities = localStorage.getItem('activities');
            allActivities = savedActivities ? JSON.parse(savedActivities) : [];
            
            console.log('Loaded activities:', allActivities.length);
            console.log('Activities with mood:', allActivities.filter(a => a.mood && a.moodEmoji).length);

            const savedCurrent = localStorage.getItem('currentActivity');
            if (savedCurrent) {
                currentActivity = JSON.parse(savedCurrent);
                const today = new Date().toDateString();
                if (new Date(currentActivity.start).toDateString() === today) {
                    showTrackingCard();
                    startTimer();
                } else {
                    currentActivity = null;
                    localStorage.removeItem('currentActivity');
                }
            }
            
            // Load custom mood colors
            const savedColors = localStorage.getItem('customMoodColors');
            if (savedColors) {
                customMoodColors = JSON.parse(savedColors);
            }
        }

        function saveData() {
            localStorage.setItem('activityTagsV2', JSON.stringify(tags));
            localStorage.setItem('activities', JSON.stringify(allActivities));
            if (currentActivity) {
                localStorage.setItem('currentActivity', JSON.stringify(currentActivity));
            } else {
                localStorage.removeItem('currentActivity');
            }
        }

        function getTagById(id, tagList = tags) {
            for (const tag of tagList) {
                if (tag.id === id) return tag;
                if (tag.children) {
                    const found = getTagById(id, tag.children);
                    if (found) return found;
                }
            }
            return null;
        }

        function getTagFullPath(tagId) {
            const path = [];
            const findPath = (id, tagList, currentPath) => {
                for (const tag of tagList) {
                    const newPath = [...currentPath, tag];
                    if (tag.id === id) {
                        path.push(...newPath);
                        return true;
                    }
                    if (tag.children && findPath(id, tag.children, newPath)) {
                        return true;
                    }
                }
                return false;
            };
            findPath(tagId, tags, []);
            return path;
        }

        function getCurrentTags() {
            if (selectedTagPath.length === 0) return tags;
            const lastId = selectedTagPath[selectedTagPath.length - 1];
            const parentTag = getTagById(lastId);
            return parentTag ? parentTag.children : [];
        }

        // UI Rendering
        function updateDateDisplay() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('displayDate').textContent = currentViewDate.toLocaleDateString('en-US', options);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const viewDate = new Date(currentViewDate);
            viewDate.setHours(0, 0, 0, 0);
            document.getElementById('nextBtn').disabled = viewDate >= today;
        }

        function changeDate(days) {
            currentViewDate.setDate(currentViewDate.getDate() + days);
            updateDateDisplay();
            renderCurrentView();
        }

        function switchMainView(view) {
            currentMainView = view;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('dailyView').style.display = view === 'daily' ? 'block' : 'none';
            document.getElementById('weeklyView').style.display = view === 'weekly' ? 'block' : 'none';
            document.getElementById('monthlyView').style.display = view === 'monthly' ? 'block' : 'none';
            renderCurrentView();
        }

        function switchChartType(type) {
            currentChartType = type;
            document.querySelectorAll('.chart-tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('barChartView').style.display = 'none';
            document.getElementById('pieChartView').style.display = 'none';
            document.getElementById('sunburstView').style.display = 'none';
            document.getElementById('timelineView').style.display = 'none';
            document.getElementById('trendView').style.display = 'none';
            document.getElementById('moodView').style.display = 'none';
            
            if (type === 'bar') {
                document.getElementById('barChartView').style.display = 'block';
            } else if (type === 'pie') {
                document.getElementById('pieChartView').style.display = 'block';
                renderPieCharts();
            } else if (type === 'sunburst') {
                document.getElementById('sunburstView').style.display = 'block';
                renderSunburstChart();
            } else if (type === 'timeline') {
                document.getElementById('timelineView').style.display = 'block';
                renderTimeline();
            } else if (type === 'trend') {
                document.getElementById('trendView').style.display = 'block';
                renderTrendChart();
            } else if (type === 'mood') {
                document.getElementById('moodView').style.display = 'block';
                renderMoodCharts();
            }
        }

        function renderCurrentView() {
            if (currentMainView === 'daily') renderDailyView();
            else if (currentMainView === 'weekly') renderWeeklyView();
            else if (currentMainView === 'monthly') renderMonthlyView();
        }

        function renderDailyView() {
            const dateStr = currentViewDate.toDateString();
            const activities = allActivities.filter(a => new Date(a.start).toDateString() === dateStr);
            updateSummary(activities);
            renderActivitiesList(activities);
            if (currentChartType === 'pie') renderPieCharts();
            else if (currentChartType === 'sunburst') renderSunburstChart();
            else if (currentChartType === 'timeline') renderTimeline();
            else if (currentChartType === 'trend') renderTrendChart();
            else if (currentChartType === 'mood') renderMoodCharts();
        }

        function updateSummary(activities) {
            const totalMs = activities.reduce((sum, a) => sum + a.duration, 0);
            const hours = Math.floor(totalMs / 3600000);
            const minutes = Math.floor((totalMs % 3600000) / 60000);
            document.getElementById('totalTime').textContent = `${hours}h ${minutes}m`;
            document.getElementById('totalActivities').textContent = activities.length;
            renderBarCharts(activities);
        }

        function renderBarCharts(activities) {
            const tagStats = {};
            activities.forEach(a => {
                const key = a.tagFullPath || a.tag;
                tagStats[key] = (tagStats[key] || 0) + a.duration;
            });

            const totalTime = Object.values(tagStats).reduce((sum, val) => sum + val, 0);
            const tagChart = document.getElementById('tagBarChart');
            
            if (Object.keys(tagStats).length === 0) {
                tagChart.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><p>No data</p></div>';
            } else {
                tagChart.innerHTML = Object.entries(tagStats)
                    .sort((a, b) => b[1] - a[1])
                    .map(([tag, ms]) => {
                        const hours = Math.floor(ms / 3600000);
                        const minutes = Math.floor((ms % 3600000) / 60000);
                        const percentage = totalTime > 0 ? (ms / totalTime * 100) : 0;
                        const activity = activities.find(a => (a.tagFullPath || a.tag) === tag);
                        const color = activity ? activity.tagColor : '#667eea';
                        return `
                            <div class="chart-bar">
                                <div class="chart-label">
                                    <span>${tag}</span>
                                    <span>${hours}h ${minutes}m</span>
                                </div>
                                <div class="chart-bar-bg">
                                    <div class="chart-bar-fill" style="width: ${percentage}%; background: ${color};">
                                        ${percentage > 15 ? Math.round(percentage) + '%' : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
            }

            const appStats = {};
            activities.forEach(a => appStats[a.app] = (appStats[a.app] || 0) + a.duration);
            const appChart = document.getElementById('appBarChart');
            
            if (Object.keys(appStats).length === 0) {
                appChart.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì±</div><p>No data</p></div>';
            } else {
                appChart.innerHTML = Object.entries(appStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10)
                    .map(([app, ms]) => {
                        const hours = Math.floor(ms / 3600000);
                        const minutes = Math.floor((ms % 3600000) / 60000);
                        const percentage = totalTime > 0 ? (ms / totalTime * 100) : 0;
                        return `
                            <div class="chart-bar">
                                <div class="chart-label">
                                    <span>${app}</span>
                                    <span>${hours}h ${minutes}m</span>
                                </div>
                                <div class="chart-bar-bg">
                                    <div class="chart-bar-fill" style="width: ${percentage}%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);">
                                        ${percentage > 15 ? Math.round(percentage) + '%' : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
            }

            // Device chart
            const deviceStats = {};
            activities.forEach(a => {
                const device = a.device || a.deviceType || 'Unknown';
                deviceStats[device] = (deviceStats[device] || 0) + a.duration;
            });
            
            const deviceChart = document.getElementById('deviceBarChart');
            
            if (Object.keys(deviceStats).length === 0) {
                deviceChart.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì±</div><p>No data</p></div>';
            } else {
                deviceChart.innerHTML = Object.entries(deviceStats)
                    .sort((a, b) => b[1] - a[1])
                    .map(([device, ms]) => {
                        const hours = Math.floor(ms / 3600000);
                        const minutes = Math.floor((ms % 3600000) / 60000);
                        const percentage = totalTime > 0 ? (ms / totalTime * 100) : 0;
                        const deviceType = activities.find(a => (a.device || a.deviceType) === device)?.deviceType || device;
                        const deviceIcon = getDeviceIcon(deviceType);
                        const deviceColor = getDeviceColor(deviceType);
                        return `
                            <div class="chart-bar">
                                <div class="chart-label">
                                    <span>${deviceIcon} ${device}</span>
                                    <span>${hours}h ${minutes}m</span>
                                </div>
                                <div class="chart-bar-bg">
                                    <div class="chart-bar-fill" style="width: ${percentage}%; background: ${deviceColor};">
                                        ${percentage > 15 ? Math.round(percentage) + '%' : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
            }
        }

        function renderPieCharts() {
            const dateStr = currentViewDate.toDateString();
            const activities = allActivities.filter(a => new Date(a.start).toDateString() === dateStr);
            
            renderPieChart('tagPieChart', activities, 'tagFullPath', 'tag');
            renderPieChart('appPieChart', activities, 'app', 'app');
            renderDevicePieChart('devicePieChart', activities);
            renderMoodPieChart('moodPieChart', activities);
        }

        function renderDevicePieChart(containerId, activities) {
            const container = document.getElementById(containerId);
            const deviceStats = {};
            
            activities.forEach(a => {
                const device = a.device || a.deviceType || 'Unknown';
                deviceStats[device] = (deviceStats[device] || 0) + a.duration;
            });
            
            if (Object.keys(deviceStats).length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì±</div><p>No data</p></div>';
                return;
            }
            
            const total = Object.values(deviceStats).reduce((sum, val) => sum + val, 0);
            const sortedEntries = Object.entries(deviceStats).sort((a, b) => b[1] - a[1]);
            
            let currentAngle = -90;
            const radius = 100;
            const centerX = 125;
            const centerY = 125;
            
            const slices = sortedEntries.map(([device, ms], index) => {
                const angle = (ms / total) * 360;
                const startAngle = currentAngle;
                const endAngle = currentAngle + angle;
                currentAngle = endAngle;
                
                const startRad = (startAngle * Math.PI) / 180;
                const endRad = (endAngle * Math.PI) / 180;
                
                const x1 = centerX + radius * Math.cos(startRad);
                const y1 = centerY + radius * Math.sin(startRad);
                const x2 = centerX + radius * Math.cos(endRad);
                const y2 = centerY + radius * Math.sin(endRad);
                
                const largeArc = angle > 180 ? 1 : 0;
                const activity = activities.find(a => (a.device || a.deviceType) === device);
                const deviceType = activity?.deviceType || device;
                const color = getDeviceColor(deviceType);
                
                return `<path d="M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z" fill="${color}" stroke="white" stroke-width="2"/>`;
            });
            
            const legend = sortedEntries.map(([device, ms], index) => {
                const hours = Math.floor(ms / 3600000);
                const minutes = Math.floor((ms % 3600000) / 60000);
                const percentage = ((ms / total) * 100).toFixed(1);
                const activity = activities.find(a => (a.device || a.deviceType) === device);
                const deviceType = activity?.deviceType || device;
                const color = getDeviceColor(deviceType);
                const icon = getDeviceIcon(deviceType);
                
                return `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${color};"></div>
                        <div>
                            <div><strong>${icon} ${device}</strong></div>
                            <div style="font-size: 0.85em; color: #666;">${hours}h ${minutes}m (${percentage}%)</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                <div class="pie-chart-container">
                    <svg width="250" height="250" viewBox="0 0 250 250">${slices.join('')}</svg>
                    <div style="flex: 1; min-width: 200px;">${legend}</div>
                </div>
            `;
        }

        function renderPieChart(containerId, activities, keyField, fallbackField) {
            const container = document.getElementById(containerId);
            const stats = {};
            activities.forEach(a => {
                const key = a[keyField] || a[fallbackField];
                stats[key] = (stats[key] || 0) + a.duration;
            });
            
            if (Object.keys(stats).length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ü•ß</div><p>No data</p></div>';
                return;
            }
            
            const total = Object.values(stats).reduce((sum, val) => sum + val, 0);
            const sortedEntries = Object.entries(stats).sort((a, b) => b[1] - a[1]);
            
            let currentAngle = -90;
            const radius = 100;
            const centerX = 125;
            const centerY = 125;
            
            const slices = sortedEntries.map(([key, ms], index) => {
                const angle = (ms / total) * 360;
                const startAngle = currentAngle;
                const endAngle = currentAngle + angle;
                currentAngle = endAngle;
                
                const startRad = (startAngle * Math.PI) / 180;
                const endRad = (endAngle * Math.PI) / 180;
                
                const x1 = centerX + radius * Math.cos(startRad);
                const y1 = centerY + radius * Math.sin(startRad);
                const x2 = centerX + radius * Math.cos(endRad);
                const y2 = centerY + radius * Math.sin(endRad);
                
                const largeArc = angle > 180 ? 1 : 0;
                const activity = activities.find(a => (a[keyField] || a[fallbackField]) === key);
                const color = activity ? activity.tagColor : colorOptions[index % colorOptions.length];
                
                return `<path d="M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z" fill="${color}" stroke="white" stroke-width="2"/>`;
            });
            
            const legend = sortedEntries.map(([key, ms], index) => {
                const hours = Math.floor(ms / 3600000);
                const minutes = Math.floor((ms % 3600000) / 60000);
                const percentage = ((ms / total) * 100).toFixed(1);
                const activity = activities.find(a => (a[keyField] || a[fallbackField]) === key);
                const color = activity ? activity.tagColor : colorOptions[index % colorOptions.length];
                
                return `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${color};"></div>
                        <div>
                            <div><strong>${key}</strong></div>
                            <div style="font-size: 0.85em; color: #666;">${hours}h ${minutes}m (${percentage}%)</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                <div class="pie-chart-container">
                    <svg width="250" height="250" viewBox="0 0 250 250">${slices.join('')}</svg>
                    <div style="flex: 1; min-width: 200px;">${legend}</div>
                </div>
            `;
        }

        function renderMoodPieChart(containerId, activities) {
            const container = document.getElementById(containerId);
            const moodStats = {};
            
            activities.forEach(a => {
                if (a.mood && a.moodEmoji) {
                    const key = `${a.moodEmoji} ${a.mood}`;
                    moodStats[key] = (moodStats[key] || 0) + a.duration;
                }
            });
            
            if (Object.keys(moodStats).length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üòä</div><p>No mood data yet</p></div>';
                return;
            }
            
            const total = Object.values(moodStats).reduce((sum, val) => sum + val, 0);
            const sortedEntries = Object.entries(moodStats).sort((a, b) => b[1] - a[1]);
            
            const moodColors = getMoodColors();
            
            let currentAngle = -90;
            const radius = 100;
            const centerX = 125;
            const centerY = 125;
            
            const slices = sortedEntries.map(([mood, ms], index) => {
                const angle = (ms / total) * 360;
                const startAngle = currentAngle;
                const endAngle = currentAngle + angle;
                currentAngle = endAngle;
                
                const startRad = (startAngle * Math.PI) / 180;
                const endRad = (endAngle * Math.PI) / 180;
                
                const x1 = centerX + radius * Math.cos(startRad);
                const y1 = centerY + radius * Math.sin(startRad);
                const x2 = centerX + radius * Math.cos(endRad);
                const y2 = centerY + radius * Math.sin(endRad);
                
                const largeArc = angle > 180 ? 1 : 0;
                const moodName = mood.split(' ')[1];
                const color = moodColors[moodName] || colorOptions[index % colorOptions.length];
                
                return `<path d="M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z" fill="${color}" stroke="white" stroke-width="2"/>`;
            });
            
            const legend = sortedEntries.map(([mood, ms], index) => {
                const hours = Math.floor(ms / 3600000);
                const minutes = Math.floor((ms % 3600000) / 60000);
                const percentage = ((ms / total) * 100).toFixed(1);
                const moodName = mood.split(' ')[1];
                const color = moodColors[moodName] || colorOptions[index % colorOptions.length];
                
                return `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${color};"></div>
                        <div>
                            <div><strong>${mood}</strong></div>
                            <div style="font-size: 0.85em; color: #666;">${hours}h ${minutes}m (${percentage}%)</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                <div class="pie-chart-container">
                    <svg width="250" height="250" viewBox="0 0 250 250">${slices.join('')}</svg>
                    <div style="flex: 1; min-width: 200px;">${legend}</div>
                </div>
            `;
        }

        function renderSunburstChart() {
            const dateStr = currentViewDate.toDateString();
            const activities = allActivities.filter(a => new Date(a.start).toDateString() === dateStr);
            
            if (activities.length === 0) {
                document.getElementById('sunburstChart').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚òÄÔ∏è</div><p>No data</p></div>';
                document.getElementById('sunburstLegend').innerHTML = '';
                return;
            }

            // Build hierarchical data structure
            const hierarchy = { name: 'root', children: [], value: 0 };
            
            activities.forEach(activity => {
                const pathTags = getTagFullPath(activity.tagId);
                let current = hierarchy;
                
                pathTags.forEach((tag, level) => {
                    let child = current.children.find(c => c.name === tag.name);
                    if (!child) {
                        child = {
                            name: tag.name,
                            color: tag.color,
                            children: [],
                            value: 0,
                            level: level
                        };
                        current.children.push(child);
                    }
                    child.value += activity.duration;
                    current = child;
                });
            });

            const size = 400;
            const centerX = size / 2;
            const centerY = size / 2;
            const innerRadius = 60;
            const ringWidth = 80;

            let paths = [];
            let legendItems = [];

            function createArcs(node, level, startAngle, endAngle) {
                if (!node.children || node.children.length === 0) return;

                const radius1 = innerRadius + level * ringWidth;
                const radius2 = radius1 + ringWidth;

                let currentAngle = startAngle;
                const totalValue = node.children.reduce((sum, child) => sum + child.value, 0);

                node.children.forEach((child, index) => {
                    const angleSpan = ((endAngle - startAngle) * child.value) / totalValue;
                    const childEndAngle = currentAngle + angleSpan;

                    const startRad1 = (currentAngle - 90) * Math.PI / 180;
                    const endRad1 = (childEndAngle - 90) * Math.PI / 180;

                    const x1 = centerX + radius1 * Math.cos(startRad1);
                    const y1 = centerY + radius1 * Math.sin(startRad1);
                    const x2 = centerX + radius2 * Math.cos(startRad1);
                    const y2 = centerY + radius2 * Math.sin(startRad1);
                    const x3 = centerX + radius2 * Math.cos(endRad1);
                    const y3 = centerY + radius2 * Math.sin(endRad1);
                    const x4 = centerX + radius1 * Math.cos(endRad1);
                    const y4 = centerY + radius1 * Math.sin(endRad1);

                    const largeArc = angleSpan > 180 ? 1 : 0;

                    const path = `M ${x1} ${y1} L ${x2} ${y2} A ${radius2} ${radius2} 0 ${largeArc} 1 ${x3} ${y3} L ${x4} ${y4} A ${radius1} ${radius1} 0 ${largeArc} 0 ${x1} ${y1} Z`;

                    paths.push(`<path class="sunburst-arc" d="${path}" fill="${child.color}" stroke="white" stroke-width="2" opacity="0.9"/>`);

                    const hours = Math.floor(child.value / 3600000);
                    const minutes = Math.floor((child.value % 3600000) / 60000);
                    legendItems.push({
                        name: child.name,
                        color: child.color,
                        time: `${hours}h ${minutes}m`,
                        level: level
                    });

                    createArcs(child, level + 1, currentAngle, childEndAngle);
                    currentAngle = childEndAngle;
                });
            }

            createArcs(hierarchy, 0, 0, 360);

            document.getElementById('sunburstChart').innerHTML = `
                <svg class="sunburst-svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
                    ${paths.join('')}
                    <circle cx="${centerX}" cy="${centerY}" r="${innerRadius}" fill="white" stroke="#e0e0e0" stroke-width="2"/>
                    <text x="${centerX}" y="${centerY}" text-anchor="middle" dominant-baseline="middle" font-size="14" fill="#666" font-weight="600">
                        All Tags
                    </text>
                </svg>
            `;

            const groupedLegend = legendItems.reduce((acc, item) => {
                if (!acc[item.level]) acc[item.level] = [];
                acc[item.level].push(item);
                return acc;
            }, {});

            let legendHTML = '';
            Object.keys(groupedLegend).sort().forEach(level => {
                groupedLegend[level].forEach(item => {
                    legendHTML += `
                        <div class="legend-item">
                            <div class="legend-color" style="background: ${item.color};"></div>
                            <div>
                                <div><strong>${'„ÄÄ'.repeat(parseInt(level))}${item.name}</strong></div>
                                <div style="font-size: 0.85em; color: #666;">${item.time}</div>
                            </div>
                        </div>
                    `;
                });
            });

            document.getElementById('sunburstLegend').innerHTML = legendHTML;
        }

        function renderTimeline() {
            const dateStr = currentViewDate.toDateString();
            const activities = allActivities.filter(a => new Date(a.start).toDateString() === dateStr);
            const container = document.getElementById('dailyTimeline');
            
            if (activities.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚è∞</div><p>No activities</p></div>';
                return;
            }

            let hoursHTML = '';
            let gridHTML = '';
            for (let i = 0; i <= 24; i++) {
                const label = i === 0 ? '12 AM' : i === 12 ? '12 PM' : i < 12 ? `${i} AM` : `${i - 12} PM`;
                hoursHTML += `<div class="hour-marker" style="top: ${(i / 24) * 100}%;">${label}</div>`;
                gridHTML += `<div class="timeline-hour-line" style="top: ${(i / 24) * 100}%;"></div>`;
            }

            const blocksHTML = activities.map(activity => {
                const start = new Date(activity.start);
                const end = new Date(activity.end);
                const startHour = start.getHours() + start.getMinutes() / 60;
                const endHour = end.getHours() + end.getMinutes() / 60;
                const top = (startHour / 24) * 100;
                const height = ((endHour - startHour) / 24) * 100;
                
                return `
                    <div class="timeline-block" style="top: ${top}%; height: ${height}%; background: ${activity.tagColor};">
                        <div><strong>${activity.tagFullPath || activity.tag}</strong></div>
                        <div style="margin-top: 4px;">${activity.app}</div>
                        <div style="font-size: 0.75em; margin-top: 4px; opacity: 0.9;">
                            ${start.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})} - 
                            ${end.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="timeline-hours">${hoursHTML}</div>
                <div class="timeline-grid">${gridHTML}${blocksHTML}</div>
            `;
        }

        function renderTrendChart() {
            const endDate = new Date(currentViewDate);
            endDate.setHours(23, 59, 59, 999);
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - 6);
            startDate.setHours(0, 0, 0, 0);

            const dayData = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                const dateStr = date.toDateString();
                const dayActivities = allActivities.filter(a => new Date(a.start).toDateString() === dateStr);
                const totalMs = dayActivities.reduce((sum, a) => sum + a.duration, 0);
                const hours = totalMs / 3600000;
                dayData.push({ date: date, hours: hours, label: `${date.getMonth() + 1}/${date.getDate()}` });
            }

            const container = document.getElementById('trendChart');
            const width = container.clientWidth - 40;
            const height = 260;
            const maxHours = Math.max(...dayData.map(d => d.hours), 1);
            const yScale = (height - 40) / maxHours;
            const xStep = width / 6;

            const points = dayData.map((d, i) => ({
                x: i * xStep,
                y: height - 20 - (d.hours * yScale)
            }));

            const linePath = points.map((p, i) => 
                `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`
            ).join(' ');

            const gridLines = [];
            for (let i = 0; i <= 5; i++) {
                const y = 20 + (i * (height - 40) / 5);
                const value = (maxHours * (5 - i) / 5).toFixed(1);
                gridLines.push(`
                    <line class="trend-grid-line" x1="0" y1="${y}" x2="${width}" y2="${y}"/>
                    <text class="trend-label" x="-5" y="${y + 4}" text-anchor="end">${value}h</text>
                `);
            }

            const xLabels = dayData.map((d, i) => 
                `<text class="trend-label" x="${i * xStep}" y="${height}" text-anchor="middle">${d.label}</text>`
            ).join('');

            const pointsHTML = points.map((p, i) => 
                `<circle class="trend-point" cx="${p.x}" cy="${p.y}" r="5">
                    <title>${dayData[i].label}: ${dayData[i].hours.toFixed(1)}h</title>
                </circle>`
            ).join('');

            container.innerHTML = `
                <svg class="trend-svg" viewBox="-30 0 ${width + 60} ${height + 20}">
                    ${gridLines.join('')}
                    <path class="trend-line" d="${linePath}"/>
                    ${pointsHTML}
                    ${xLabels}
                </svg>
            `;
        }

        function renderMoodCharts() {
            const dateStr = currentViewDate.toDateString();
            const activities = allActivities.filter(a => new Date(a.start).toDateString() === dateStr);
            console.log('Total activities for today:', activities.length);
            console.log('Activities:', activities);
            
            const moodActivities = activities.filter(a => a.mood && a.moodEmoji);
            console.log('Mood activities:', moodActivities.length);
            console.log('Mood activities data:', moodActivities);
            
            if (moodActivities.length === 0) {
                document.getElementById('moodStatsCards').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üòä</div><p>No mood data for this day. Start tracking activities with mood!</p></div>';
                document.getElementById('moodDistChart').innerHTML = '';
                document.getElementById('moodByActivityChart').innerHTML = '';
                document.getElementById('moodActivityBreakdownChart').innerHTML = '';
                return;
            }
            
            // Mood stats cards
            const moodStats = {};
            moodActivities.forEach(a => {
                moodStats[a.mood] = (moodStats[a.mood] || 0) + a.duration;
            });
            
            const totalMoodTime = Object.values(moodStats).reduce((sum, val) => sum + val, 0);
            const sortedMoods = Object.entries(moodStats).sort((a, b) => b[1] - a[1]);
            const topMood = sortedMoods[0];
            
            const moodEmojis = {
                'Happy': 'üòä', 'Calm': 'üòå', 'Focused': 'ü§î', 'Tired': 'üò´',
                'Frustrated': 'üò§', 'Excited': 'üòÑ', 'Neutral': 'üòê', 'Productive': 'üí™',
                'Stressed': 'üò©', 'Bored': 'ü•±', 'Confident': 'üòé', 'Satisfied': 'ü§ó',
                'Anxious': 'üò∞', 'Content': 'üôÇ', 'Relieved': 'üòÆ‚Äçüí®'
            };
            
            const hours = Math.floor(totalMoodTime / 3600000);
            const minutes = Math.floor((totalMoodTime % 3600000) / 60000);
            
            document.getElementById('moodStatsCards').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Activities with Mood</div>
                        <div class="stat-value">${moodActivities.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Tracked Time</div>
                        <div class="stat-value">${hours}h ${minutes}m</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Dominant Mood</div>
                        <div class="stat-value">${moodEmojis[topMood[0]]} ${topMood[0]}</div>
                    </div>
                </div>
            `;
            
            // Mood-Activity relationship pie chart
            renderMoodActivityPieChart(moodActivities, moodEmojis);
            
            // Activity-Mood relationship pie chart (reverse perspective)
            renderActivityMoodPieChart(moodActivities, moodEmojis);
            
            // Mood distribution chart
            renderMoodDistributionChart(moodStats, moodEmojis);
            
            // Mood by activity chart
            renderMoodByActivityAnalysis(moodActivities, moodEmojis);
            
            // Activity breakdown by mood
            renderMoodActivityDetails(moodActivities, moodEmojis);
        }

        function renderMoodActivityPieChart(activities, moodEmojis) {
            const container = document.getElementById('moodActivityPieChart');
            
            // Group activities by mood
            const moodData = {};
            activities.forEach(a => {
                const mood = a.mood;
                if (!moodData[mood]) {
                    moodData[mood] = {
                        total: 0,
                        activities: {}
                    };
                }
                const activityKey = a.tagFullPath || a.tag;
                moodData[mood].activities[activityKey] = (moodData[mood].activities[activityKey] || 0) + a.duration;
                moodData[mood].total += a.duration;
            });
            
            const moodColors = getMoodColors();
            
            const totalTime = Object.values(moodData).reduce((sum, m) => sum + m.total, 0);
            const sortedMoods = Object.entries(moodData).sort((a, b) => b[1].total - a[1].total);
            
            // SVG setup
            const size = 550;
            const centerX = size / 2;
            const centerY = size / 2;
            const radius = 180;
            
            let currentAngle = -90;
            let svgContent = '';
            let textElements = '';
            
            sortedMoods.forEach(([mood, data]) => {
                const moodAngle = (data.total / totalTime) * 360;
                const startAngle = currentAngle;
                const endAngle = currentAngle + moodAngle;
                const midAngle = (startAngle + endAngle) / 2;
                
                // Draw mood slice
                const startRad = (startAngle * Math.PI) / 180;
                const endRad = (endAngle * Math.PI) / 180;
                
                const x1 = centerX + radius * Math.cos(startRad);
                const y1 = centerY + radius * Math.sin(startRad);
                const x2 = centerX + radius * Math.cos(endRad);
                const y2 = centerY + radius * Math.sin(endRad);
                
                const largeArc = moodAngle > 180 ? 1 : 0;
                const color = moodColors[mood] || '#C9ADA7';
                
                svgContent += `<path d="M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z" fill="${color}" stroke="white" stroke-width="3" opacity="0.9"/>`;
                
                // Calculate position for mood emoji (closer to center)
                const emojiDistance = radius * 0.35;
                const emojiRad = (midAngle * Math.PI) / 180;
                const emojiX = centerX + emojiDistance * Math.cos(emojiRad);
                const emojiY = centerY + emojiDistance * Math.sin(emojiRad);
                
                const emoji = moodEmojis[mood] || 'üòä';
                textElements += `<text x="${emojiX}" y="${emojiY}" text-anchor="middle" dominant-baseline="middle" font-size="32" style="pointer-events: none;">${emoji}</text>`;
                
                // Add activities as text in the slice
                const sortedActivities = Object.entries(data.activities).sort((a, b) => b[1] - a[1]);
                
                // Calculate font sizes based on time proportion within this mood
                sortedActivities.forEach(([ activity, duration], actIndex) => {
                    const activityProportion = duration / data.total;
                    const baseFontSize = 11;
                    const maxFontSize = 18;
                    const fontSize = Math.max(baseFontSize, Math.min(maxFontSize, baseFontSize + activityProportion * 15));
                    
                    // Position text along the arc
                    const textDistance = radius * (0.6 + actIndex * 0.15);
                    const textRad = (midAngle * Math.PI) / 180;
                    const textX = centerX + textDistance * Math.cos(textRad);
                    const textY = centerY + textDistance * Math.sin(textRad);
                    
                    // Calculate rotation for radial text
                    let textAngle = midAngle + 90;
                    if (textAngle > 90 && textAngle < 270) {
                        textAngle += 180;
                    }
                    
                    // Truncate long activity names
                    const maxLength = Math.floor(fontSize / 1.5);
                    let displayActivity = activity;
                    
                    // For very long paths (6 levels), intelligently truncate
                    const parts = activity.split(' ‚Ä∫ ');
                    if (parts.length > 3) {
                        // Show first level ... last level
                        displayActivity = `${parts[0]} ‚Ä∫ ... ‚Ä∫ ${parts[parts.length - 1]}`;
                    }
                    
                    if (displayActivity.length > maxLength) {
                        displayActivity = displayActivity.substring(0, maxLength) + '...';
                    }
                    
                    const hours = Math.floor(duration / 3600000);
                    const minutes = Math.floor((duration % 3600000) / 60000);
                    const timeText = hours > 0 ? `${hours}h${minutes}m` : `${minutes}m`;
                    
                    textElements += `
                        <g transform="translate(${textX}, ${textY}) rotate(${textAngle})">
                            <text text-anchor="middle" dominant-baseline="middle" font-size="${fontSize}" font-weight="600" fill="white" stroke="rgba(0,0,0,0.3)" stroke-width="0.5" style="paint-order: stroke; pointer-events: none;">
                                ${displayActivity}
                            </text>
                            <text text-anchor="middle" dominant-baseline="middle" y="${fontSize + 5}" font-size="${fontSize * 0.7}" fill="white" opacity="0.9" stroke="rgba(0,0,0,0.3)" stroke-width="0.5" style="paint-order: stroke; pointer-events: none;">
                                ${timeText}
                            </text>
                        </g>
                    `;
                });
                
                currentAngle = endAngle;
            });
            
            container.innerHTML = `
                <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" style="max-width: 100%; height: auto;">
                    ${svgContent}
                    ${textElements}
                </svg>
            `;
        }

        function renderActivityMoodPieChart(activities, moodEmojis) {
            const container = document.getElementById('activityMoodPieChart');
            
            // Group activities by activity name (use full path for detail)
            const activityData = {};
            activities.forEach(a => {
                const activityKey = a.tagFullPath || a.tag;
                if (!activityData[activityKey]) {
                    activityData[activityKey] = {
                        total: 0,
                        moods: {}
                    };
                }
                const mood = a.mood;
                activityData[activityKey].moods[mood] = (activityData[activityKey].moods[mood] || 0) + a.duration;
                activityData[activityKey].total += a.duration;
            });
            
            const moodColors = getMoodColors();
            
            const totalTime = Object.values(activityData).reduce((sum, a) => sum + a.total, 0);
            const sortedActivities = Object.entries(activityData).sort((a, b) => b[1].total - a[1].total);
            
            // SVG setup
            const size = 550;
            const centerX = size / 2;
            const centerY = size / 2;
            const radius = 180;
            
            let currentAngle = -90;
            let svgContent = '';
            let textElements = '';
            
            sortedActivities.forEach(([activity, data]) => {
                const activityAngle = (data.total / totalTime) * 360;
                const startAngle = currentAngle;
                const endAngle = currentAngle + activityAngle;
                const midAngle = (startAngle + endAngle) / 2;
                
                // Calculate dominant mood for this activity (for color)
                const sortedMoods = Object.entries(data.moods).sort((a, b) => b[1] - a[1]);
                const dominantMood = sortedMoods[0][0];
                const dominantColor = moodColors[dominantMood] || '#C9ADA7';
                
                // Draw activity slice
                const startRad = (startAngle * Math.PI) / 180;
                const endRad = (endAngle * Math.PI) / 180;
                
                const x1 = centerX + radius * Math.cos(startRad);
                const y1 = centerY + radius * Math.sin(startRad);
                const x2 = centerX + radius * Math.cos(endRad);
                const y2 = centerY + radius * Math.sin(endRad);
                
                const largeArc = activityAngle > 180 ? 1 : 0;
                
                // Create gradient effect with multiple moods
                let sliceColor = dominantColor;
                if (sortedMoods.length > 1) {
                    // Mix colors based on mood proportions
                    sliceColor = dominantColor; // Keep dominant for now
                }
                
                svgContent += `<path d="M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z" fill="${sliceColor}" stroke="white" stroke-width="3" opacity="0.9"/>`;
                
                // Add activity name in the center area
                const activityDistance = radius * 0.35;
                const activityRad = (midAngle * Math.PI) / 180;
                const activityX = centerX + activityDistance * Math.cos(activityRad);
                const activityY = centerY + activityDistance * Math.sin(activityRad);
                
                // Truncate long activity names for center display
                const shortActivity = activity.split(' ‚Ä∫ ').pop();
                const displayShortName = shortActivity.length > 8 ? shortActivity.substring(0, 8) + '...' : shortActivity;
                
                let textAngle = midAngle + 90;
                if (textAngle > 90 && textAngle < 270) {
                    textAngle += 180;
                }
                
                textElements += `
                    <g transform="translate(${activityX}, ${activityY}) rotate(${textAngle})">
                        <text text-anchor="middle" dominant-baseline="middle" font-size="14" font-weight="700" fill="white" stroke="rgba(0,0,0,0.4)" stroke-width="0.8" style="paint-order: stroke; pointer-events: none;">
                            ${displayShortName}
                        </text>
                    </g>
                `;
                
                // Add mood emojis and activity names (sized by Happy proportion)
                sortedMoods.forEach(([mood, duration], moodIndex) => {
                    const moodProportion = duration / data.total;
                    const emoji = moodEmojis[mood] || 'üòä';
                    
                    // Special handling: size activity name by Happy proportion
                    let fontSizeMultiplier = 1.0;
                    if (mood === 'Happy') {
                        // Activity name font size is proportional to Happy percentage
                        // Range: 11px (low Happy) to 20px (high Happy)
                        const baseFontSize = 11;
                        const maxFontSize = 20;
                        fontSizeMultiplier = baseFontSize + (moodProportion * (maxFontSize - baseFontSize));
                    } else {
                        // Other moods: standard sizing by their proportion
                        const baseFontSize = 10;
                        const maxFontSize = 16;
                        fontSizeMultiplier = Math.max(baseFontSize, baseFontSize + moodProportion * 12);
                    }
                    
                    const fontSize = fontSizeMultiplier;
                    
                    // Position text along the arc
                    const textDistance = radius * (0.58 + moodIndex * 0.17);
                    const textRad = (midAngle * Math.PI) / 180;
                    const textX = centerX + textDistance * Math.cos(textRad);
                    const textY = centerY + textDistance * Math.sin(textRad);
                    
                    const hours = Math.floor(duration / 3600000);
                    const minutes = Math.floor((duration % 3600000) / 60000);
                    const timeText = hours > 0 ? `${hours}h${minutes}m` : `${minutes}m`;
                    const percentage = (moodProportion * 100).toFixed(0);
                    
                    // For Happy mood, show full activity path with larger font
                    let displayText = '';
                    if (mood === 'Happy') {
                        // Show full path for Happy activities, intelligently truncated
                        const parts = activity.split(' ‚Ä∫ ');
                        let fullPath = activity;
                        
                        // For 6-level tags, show: Level1 ‚Ä∫ Level2 ‚Ä∫ ... ‚Ä∫ Level6
                        if (parts.length > 4) {
                            fullPath = `${parts[0]} ‚Ä∫ ${parts[1]} ‚Ä∫ ... ‚Ä∫ ${parts[parts.length - 1]}`;
                        }
                        
                        const maxLength = Math.floor(fontSize / 1.2);
                        displayText = fullPath.length > maxLength ? fullPath.substring(0, maxLength) + '...' : fullPath;
                    } else {
                        // Show emoji for other moods
                        displayText = emoji;
                    }
                    
                    textElements += `
                        <g transform="translate(${textX}, ${textY}) rotate(${textAngle})">
                            <text text-anchor="middle" dominant-baseline="middle" font-size="${fontSize}" font-weight="${mood === 'Happy' ? '700' : '400'}" fill="white" stroke="rgba(0,0,0,0.3)" stroke-width="0.5" style="paint-order: stroke; pointer-events: none;">
                                ${displayText}
                            </text>
                            <text text-anchor="middle" dominant-baseline="middle" y="${fontSize + 4}" font-size="${fontSize * 0.65}" fill="white" opacity="0.9" stroke="rgba(0,0,0,0.3)" stroke-width="0.5" style="paint-order: stroke; pointer-events: none;">
                                ${percentage}% ¬∑ ${timeText}
                            </text>
                        </g>
                    `;
                });
                
                currentAngle = endAngle;
            });
            
            container.innerHTML = `
                <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" style="max-width: 100%; height: auto;">
                    ${svgContent}
                    ${textElements}
                    <text x="${centerX}" y="${centerX}" text-anchor="middle" dominant-baseline="middle" font-size="16" fill="#666" font-weight="600">
                        Activity ‚Üí Mood
                    </text>
                </svg>
            `;
        }

        function renderMoodDistributionChart(moodStats, moodEmojis) {
            const container = document.getElementById('moodDistChart');
            const totalTime = Object.values(moodStats).reduce((sum, val) => sum + val, 0);
            
            const moodColors = getMoodColors();
            
            container.innerHTML = Object.entries(moodStats)
                .sort((a, b) => b[1] - a[1])
                .map(([mood, ms]) => {
                    const hours = Math.floor(ms / 3600000);
                    const minutes = Math.floor((ms % 3600000) / 60000);
                    const percentage = totalTime > 0 ? (ms / totalTime * 100) : 0;
                    const color = moodColors[mood] || '#C9ADA7';
                    const emoji = moodEmojis[mood] || 'üòä';
                    
                    return `
                        <div class="chart-bar">
                            <div class="chart-label">
                                <span style="font-size: 1.2em;">${emoji} ${mood}</span>
                                <span>${hours}h ${minutes}m</span>
                            </div>
                            <div class="chart-bar-bg">
                                <div class="chart-bar-fill" style="width: ${percentage}%; background: ${color};">
                                    ${percentage > 15 ? Math.round(percentage) + '%' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function renderMoodByActivityAnalysis(activities, moodEmojis) {
            const container = document.getElementById('moodByActivityChart');
            const tagMoodStats = {};
            
            activities.forEach(a => {
                const tag = a.tagFullPath || a.tag;
                if (!tagMoodStats[tag]) tagMoodStats[tag] = {};
                const mood = a.mood;
                tagMoodStats[tag][mood] = (tagMoodStats[tag][mood] || 0) + a.duration;
            });
            
            const moodColors = getMoodColors();
            
            let html = '';
            Object.entries(tagMoodStats)
                .sort((a, b) => {
                    const totalA = Object.values(a[1]).reduce((sum, val) => sum + val, 0);
                    const totalB = Object.values(b[1]).reduce((sum, val) => sum + val, 0);
                    return totalB - totalA;
                })
                .forEach(([tag, moods]) => {
                    const total = Object.values(moods).reduce((sum, val) => sum + val, 0);
                    const hours = Math.floor(total / 3600000);
                    const minutes = Math.floor((total % 3600000) / 60000);
                    const sortedMoods = Object.entries(moods).sort((a, b) => b[1] - a[1]);
                    
                    html += `<div style="margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-radius: 12px;">`;
                    html += `<h4 style="margin-bottom: 5px; color: #333;">${tag}</h4>`;
                    html += `<p style="color: #999; font-size: 0.9em; margin-bottom: 15px;">Total: ${hours}h ${minutes}m</p>`;
                    
                    sortedMoods.forEach(([mood, ms]) => {
                        const moodHours = Math.floor(ms / 3600000);
                        const moodMinutes = Math.floor((ms % 3600000) / 60000);
                        const percentage = (ms / total * 100);
                        const color = moodColors[mood] || '#C9ADA7';
                        const emoji = moodEmojis[mood] || 'üòä';
                        
                        html += `
                            <div class="chart-bar" style="margin-bottom: 8px;">
                                <div class="chart-label">
                                    <span style="font-size: 0.95em;">${emoji} ${mood}</span>
                                    <span style="font-size: 0.9em; color: #666;">${moodHours}h ${moodMinutes}m</span>
                                </div>
                                <div class="chart-bar-bg" style="height: 24px;">
                                    <div class="chart-bar-fill" style="width: ${percentage}%; background: ${color}; font-size: 0.8em;">
                                        ${percentage > 20 ? Math.round(percentage) + '%' : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                });
            
            container.innerHTML = html;
        }

        function renderMoodActivityDetails(activities, moodEmojis) {
            const container = document.getElementById('moodActivityBreakdownChart');
            const moodActivities = {};
            
            activities.forEach(a => {
                const mood = a.mood;
                if (!moodActivities[mood]) moodActivities[mood] = [];
                moodActivities[mood].push(a);
            });
            
            const moodColors = getMoodColors();
            
            let html = '';
            Object.entries(moodActivities)
                .sort((a, b) => b[1].length - a[1].length)
                .forEach(([mood, acts]) => {
                    const emoji = moodEmojis[mood] || 'üòä';
                    const color = moodColors[mood] || '#C9ADA7';
                    
                    // Group by tag
                    const tagStats = {};
                    acts.forEach(a => {
                        const tag = a.tagFullPath || a.tag;
                        tagStats[tag] = (tagStats[tag] || 0) + a.duration;
                    });
                    
                    const totalTime = Object.values(tagStats).reduce((sum, val) => sum + val, 0);
                    const topTags = Object.entries(tagStats)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5);
                    
                    const hours = Math.floor(totalTime / 3600000);
                    const minutes = Math.floor((totalTime % 3600000) / 60000);
                    
                    html += `
                        <div class="mood-breakdown-section" style="border-left: 4px solid ${color};">
                            <div class="mood-breakdown-title">
                                <span style="font-size: 2em;">${emoji}</span>
                                <div>
                                    <div style="font-size: 1.2em; font-weight: 600;">${mood}</div>
                                    <div style="color: #999; font-size: 0.85em;">${acts.length} activities ¬∑ ${hours}h ${minutes}m</div>
                                </div>
                            </div>
                            <div class="mood-activity-grid">
                    `;
                    
                    topTags.forEach(([tag, ms]) => {
                        const tagHours = Math.floor(ms / 3600000);
                        const tagMinutes = Math.floor((ms % 3600000) / 60000);
                        const percentage = ((ms / totalTime) * 100).toFixed(0);
                        
                        html += `
                            <div class="mood-activity-item" style="border-left-color: ${color};">
                                <strong style="color: #333;">${tag}</strong>
                                <div style="color: #666; margin-top: 4px;">${tagHours}h ${tagMinutes}m</div>
                                <div style="color: #999; font-size: 0.85em;">${percentage}% of ${mood}</div>
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                });
            
            container.innerHTML = html;
        }

        function renderWeeklyView() {
            const startOfWeek = new Date(currentViewDate);
            const day = startOfWeek.getDay();
            startOfWeek.setDate(startOfWeek.getDate() - day);
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            
            const weekActivities = allActivities.filter(a => {
                const activityDate = new Date(a.start);
                return activityDate >= startOfWeek && activityDate <= endOfWeek;
            });
            
            const totalMs = weekActivities.reduce((sum, a) => sum + a.duration, 0);
            const hours = Math.floor(totalMs / 3600000);
            const minutes = Math.floor((totalMs % 3600000) / 60000);
            document.getElementById('weeklyTotal').textContent = `${hours}h ${minutes}m`;
            
            const avgMs = totalMs / 7;
            const avgHours = Math.floor(avgMs / 3600000);
            const avgMinutes = Math.floor((avgMs % 3600000) / 60000);
            document.getElementById('dailyAvg').textContent = `${avgHours}h ${avgMinutes}m`;
            
            renderHeatmap('weekHeatmap', startOfWeek, 7);
            renderWeeklyTrend(startOfWeek);
            renderWeeklyTagChart(weekActivities);
        }

        function renderMonthlyView() {
            const startOfMonth = new Date(currentViewDate.getFullYear(), currentViewDate.getMonth(), 1);
            const endOfMonth = new Date(currentViewDate.getFullYear(), currentViewDate.getMonth() + 1, 0, 23, 59, 59, 999);
            
            const monthActivities = allActivities.filter(a => {
                const activityDate = new Date(a.start);
                return activityDate >= startOfMonth && activityDate <= endOfMonth;
            });
            
            const totalMs = monthActivities.reduce((sum, a) => sum + a.duration, 0);
            const hours = Math.floor(totalMs / 3600000);
            const minutes = Math.floor((totalMs % 3600000) / 60000);
            document.getElementById('monthlyTotal').textContent = `${hours}h ${minutes}m`;
            
            const uniqueDays = new Set(monthActivities.map(a => new Date(a.start).toDateString()));
            document.getElementById('activeDays').textContent = uniqueDays.size;
            
            const avgMs = uniqueDays.size > 0 ? totalMs / uniqueDays.size : 0;
            const avgHours = Math.floor(avgMs / 3600000);
            const avgMinutes = Math.floor((avgMs % 3600000) / 60000);
            document.getElementById('monthlyAvg').textContent = `${avgHours}h ${avgMinutes}m`;
            
            const daysInMonth = new Date(currentViewDate.getFullYear(), currentViewDate.getMonth() + 1, 0).getDate();
            renderHeatmap('monthHeatmap', startOfMonth, daysInMonth);
            renderMonthlyTrend(startOfMonth, daysInMonth);
            renderMonthlyTagChart(monthActivities);
        }

        function renderHeatmap(containerId, startDate, days) {
            const container = document.getElementById(containerId);
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            let maxMs = 0;
            const dayData = [];
            
            for (let i = 0; i < days; i++) {
                const currentDay = new Date(startDate);
                currentDay.setDate(currentDay.getDate() + i);
                const dayActivities = allActivities.filter(a => 
                    new Date(a.start).toDateString() === currentDay.toDateString()
                );
                const totalMs = dayActivities.reduce((sum, a) => sum + a.duration, 0);
                if (totalMs > maxMs) maxMs = totalMs;
                dayData.push({ date: currentDay, ms: totalMs });
            }
            
            const html = dayData.map(({ date, ms }) => {
                const hours = Math.floor(ms / 3600000);
                const minutes = Math.floor((ms % 3600000) / 60000);
                const intensity = maxMs > 0 ? ms / maxMs : 0;
                const bgColor = intensity > 0 ? `rgba(102, 126, 234, ${0.2 + intensity * 0.8})` : '#f0f0f0';
                const textColor = intensity > 0.5 ? 'white' : '#333';
                
                return `
                    <div class="heatmap-cell" style="background: ${bgColor}; color: ${textColor};" 
                         onclick="jumpToDate('${date.toISOString()}')">
                        <div class="heatmap-day">${date.getDate()}</div>
                        <div class="heatmap-time">${hours}h ${minutes}m</div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function renderWeeklyTrend(startDate) {
            const container = document.getElementById('weeklyTrendChart');
            const dayData = [];
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                const dateStr = date.toDateString();
                const dayActivities = allActivities.filter(a => new Date(a.start).toDateString() === dateStr);
                const totalMs = dayActivities.reduce((sum, a) => sum + a.duration, 0);
                const hours = totalMs / 3600000;
                dayData.push({ date: date, hours: hours, label: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][i] });
            }

            renderTrendSVG(container, dayData);
        }

        function renderMonthlyTrend(startDate, days) {
            const container = document.getElementById('monthlyTrendChart');
            const dayData = [];
            
            for (let i = 0; i < days; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                const dateStr = date.toDateString();
                const dayActivities = allActivities.filter(a => new Date(a.start).toDateString() === dateStr);
                const totalMs = dayActivities.reduce((sum, a) => sum + a.duration, 0);
                const hours = totalMs / 3600000;
                const showLabel = i % Math.ceil(days / 10) === 0;
                dayData.push({ date: date, hours: hours, label: showLabel ? `${date.getMonth() + 1}/${date.getDate()}` : '' });
            }

            renderTrendSVG(container, dayData);
        }

        function renderTrendSVG(container, dayData) {
            const width = container.clientWidth - 40;
            const height = 260;
            const maxHours = Math.max(...dayData.map(d => d.hours), 1);
            const yScale = (height - 40) / maxHours;
            const xStep = width / (dayData.length - 1 || 1);

            const points = dayData.map((d, i) => ({
                x: i * xStep,
                y: height - 20 - (d.hours * yScale)
            }));

            const linePath = points.map((p, i) => 
                `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`
            ).join(' ');

            const gridLines = [];
            for (let i = 0; i <= 5; i++) {
                const y = 20 + (i * (height - 40) / 5);
                const value = (maxHours * (5 - i) / 5).toFixed(1);
                gridLines.push(`
                    <line class="trend-grid-line" x1="0" y1="${y}" x2="${width}" y2="${y}"/>
                    <text class="trend-label" x="-5" y="${y + 4}" text-anchor="end">${value}h</text>
                `);
            }

            const xLabels = dayData.filter(d => d.label).map((d, i) => {
                const index = dayData.indexOf(d);
                return `<text class="trend-label" x="${index * xStep}" y="${height}" text-anchor="middle">${d.label}</text>`;
            }).join('');

            const pointsHTML = points.map((p, i) => 
                `<circle class="trend-point" cx="${p.x}" cy="${p.y}" r="4">
                    <title>${dayData[i].label || dayData[i].date.toLocaleDateString()}: ${dayData[i].hours.toFixed(1)}h</title>
                </circle>`
            ).join('');

            container.innerHTML = `
                <svg class="trend-svg" viewBox="-30 0 ${width + 60} ${height + 20}">
                    ${gridLines.join('')}
                    <path class="trend-line" d="${linePath}"/>
                    ${pointsHTML}
                    ${xLabels}
                </svg>
            `;
        }

        function renderWeeklyTagChart(activities) {
            const tagStats = {};
            activities.forEach(a => {
                const key = a.tagFullPath || a.tag;
                tagStats[key] = (tagStats[key] || 0) + a.duration;
            });

            const totalTime = Object.values(tagStats).reduce((sum, val) => sum + val, 0);
            const container = document.getElementById('weeklyTagChart');
            
            if (Object.keys(tagStats).length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><p>No data</p></div>';
                return;
            }

            container.innerHTML = Object.entries(tagStats)
                .sort((a, b) => b[1] - a[1])
                .map(([tag, ms]) => {
                    const hours = Math.floor(ms / 3600000);
                    const minutes = Math.floor((ms % 3600000) / 60000);
                    const percentage = totalTime > 0 ? (ms / totalTime * 100) : 0;
                    const activity = activities.find(a => (a.tagFullPath || a.tag) === tag);
                    const color = activity ? activity.tagColor : '#667eea';
                    
                    return `
                        <div class="chart-bar">
                            <div class="chart-label">
                                <span>${tag}</span>
                                <span>${hours}h ${minutes}m</span>
                            </div>
                            <div class="chart-bar-bg">
                                <div class="chart-bar-fill" style="width: ${percentage}%; background: ${color};">
                                    ${percentage > 15 ? Math.round(percentage) + '%' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function renderMonthlyTagChart(activities) {
            renderWeeklyTagChart(activities);
        }

        function jumpToDate(dateStr) {
            currentViewDate = new Date(dateStr);
            currentMainView = 'daily';
            switchMainView('daily');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
        }

        function renderActivitiesList(activities) {
            const list = document.getElementById('activitiesList');
            if (activities.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><p>No activities</p></div>';
                return;
            }

            list.innerHTML = activities
                .sort((a, b) => new Date(b.start) - new Date(a.start))
                .map(activity => {
                    const start = new Date(activity.start);
                    const duration = activity.duration;
                    const hours = Math.floor(duration / 3600000);
                    const minutes = Math.floor((duration % 3600000) / 60000);
                    const deviceIcon = getDeviceIcon(activity.deviceType || activity.device);
                    const deviceDisplay = activity.device || 'Unknown';
                    const moodEmoji = activity.moodEmoji || '';
                    const moodText = activity.mood || '';
                    const note = activity.note || '';
                    
                    return `
                        <div class="activity-item" style="flex-direction: column; align-items: stretch;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div class="activity-details" style="flex: 1;">
                                    <div style="margin-bottom: 5px;">
                                        <span class="tag-badge" style="background: ${activity.tagColor}; color: white; font-size: 0.85em; padding: 4px 12px;">
                                            ${activity.tagFullPath || activity.tag}
                                        </span>
                                        <span style="margin-left: 10px; color: #666;">${activity.app}</span>
                                        <span style="margin-left: 10px; font-size: 1.2em;" title="${deviceDisplay}">${deviceIcon}</span>
                                        ${moodEmoji ? `<span style="margin-left: 10px; font-size: 1.3em;" title="${moodText}">${moodEmoji}</span>` : ''}
                                    </div>
                                    <div class="activity-time">${start.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
                                </div>
                                <div class="activity-duration">${hours}h ${minutes}m</div>
                            </div>
                            ${note ? `
                                <div style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin-top: 8px; font-size: 0.9em; color: #666; border-left: 3px solid ${activity.tagColor};">
                                    üí≠ ${note}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
        }

        // Tag Management
        function renderTagHierarchy() {
            const breadcrumb = document.getElementById('tagBreadcrumb');
            if (selectedTagPath.length === 0) {
                breadcrumb.innerHTML = '<div class="breadcrumb-item active">All Tags</div>';
            } else {
                const pathTags = selectedTagPath.map(id => getTagById(id));
                breadcrumb.innerHTML = `
                    <div class="breadcrumb-item" onclick="navigateToRoot()">All Tags</div>
                    ${pathTags.map((tag, index) => `
                        <span class="breadcrumb-separator">‚Ä∫</span>
                        <div class="breadcrumb-item ${index === pathTags.length - 1 ? 'active' : ''}" 
                             onclick="navigateToTag('${tag.id}')">${tag.name}</div>
                    `).join('')}
                `;
            }

            const currentTags = getCurrentTags();
            const grid = document.getElementById('tagsGrid');
            
            if (currentTags.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No subtags yet</p>';
            } else {
                grid.innerHTML = currentTags.map(tag => {
                    const hasChildren = tag.children && tag.children.length > 0;
                    return `<button class="tag-btn ${hasChildren ? 'has-children' : ''}" 
                                    style="color: ${tag.color}; border-color: ${tag.color};" 
                                    onclick="${hasChildren ? `navigateIntoTag('${tag.id}')` : `selectTag('${tag.id}')`}">
                                ${tag.name}
                            </button>`;
                }).join('');
            }
        }

        function navigateToRoot() {
            selectedTagPath = [];
            renderTagHierarchy();
        }

        function navigateToTag(tagId) {
            const index = selectedTagPath.indexOf(tagId);
            if (index !== -1) {
                selectedTagPath = selectedTagPath.slice(0, index + 1);
            }
            renderTagHierarchy();
        }

        function navigateIntoTag(tagId) {
            selectedTagPath.push(tagId);
            renderTagHierarchy();
        }

        function selectTag(tagId) {
            const tag = getTagById(tagId);
            if (!tag) return;

            const fullPath = getTagFullPath(tagId);
            const pathNames = fullPath.map(t => t.name).join(' ‚Ä∫ ');

            document.querySelectorAll('.tag-btn').forEach(btn => {
                btn.classList.remove('selected');
                btn.style.background = 'white';
                const btnTagId = btn.textContent.trim();
                const btnTag = getCurrentTags().find(t => t.name === btnTagId);
                if (btnTag) {
                    btn.style.color = btnTag.color;
                }
            });

            const selectedBtn = Array.from(document.querySelectorAll('.tag-btn'))
                .find(btn => btn.textContent.trim() === tag.name);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
                selectedBtn.style.background = tag.color;
                selectedBtn.style.color = 'white';
            }

            window.selectedTagInfo = {
                id: tagId,
                name: tag.name,
                fullPath: pathNames,
                color: tag.color
            };
        }

        function renderQuickApps() {
            const container = document.getElementById('quickApps');
            container.innerHTML = commonApps.map(app => 
                `<button class="quick-app-btn" onclick="selectApp('${app}')">${app}</button>`
            ).join('');
        }

        function selectApp(appName) {
            document.getElementById('appInput').value = appName;
        }

        // Activity Tracking
        function startTracking() {
            if (!window.selectedTagInfo) {
                alert('Please select a tag first!');
                return;
            }

            const appName = document.getElementById('appInput').value.trim();
            if (!appName) {
                alert('Please enter an app name!');
                return;
            }

            currentActivity = {
                tagId: window.selectedTagInfo.id,
                tag: window.selectedTagInfo.name,
                tagFullPath: window.selectedTagInfo.fullPath,
                tagColor: window.selectedTagInfo.color,
                app: appName,
                device: deviceName,
                deviceType: deviceType,
                start: new Date().toISOString()
            };

            saveData();
            showTrackingCard();
            startTimer();
        }

        function showTrackingCard() {
            document.getElementById('startCard').style.display = 'none';
            document.getElementById('trackingCard').style.display = 'block';
            
            const tagBadge = document.getElementById('currentTag');
            tagBadge.textContent = currentActivity.tagFullPath;
            tagBadge.style.background = currentActivity.tagColor;
            tagBadge.style.color = 'white';
            
            document.getElementById('currentApp').textContent = currentActivity.app;
        }

        function startTimer() {
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            if (!currentActivity) return;
            
            const start = new Date(currentActivity.start);
            const now = new Date();
            const diff = Math.floor((now - start) / 1000);
            
            const hours = Math.floor(diff / 3600);
            const minutes = Math.floor((diff % 3600) / 60);
            const seconds = diff % 60;
            
            document.getElementById('timer').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function stopTracking() {
            if (!currentActivity) return;

            const endTime = new Date().toISOString();
            const activity = {
                ...currentActivity,
                end: endTime,
                duration: new Date(endTime) - new Date(currentActivity.start)
            };

            allActivities.push(activity);
            currentActivity = null;
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            saveData();
            
            document.getElementById('trackingCard').style.display = 'none';
            document.getElementById('startCard').style.display = 'block';
            document.getElementById('appInput').value = '';
            window.selectedTagInfo = null;
            selectedTagPath = [];
            renderTagHierarchy();
            
            renderCurrentView();
        }

        // Data Export
        function exportData() {
            if (allActivities.length === 0) {
                alert('No data to export!');
                return;
            }

            let csv = 'Date,Start Time,End Time,Duration (minutes),Tag Path,Tag ID,App,Device,Device Type,Mood Emoji,Mood,Note\n';
            
            allActivities.forEach(activity => {
                const start = new Date(activity.start);
                const end = new Date(activity.end);
                const durationMin = Math.round(activity.duration / 60000);
                const tagPath = activity.tagFullPath || activity.tag;
                const tagId = activity.tagId || '';
                const device = activity.device || 'Unknown';
                const deviceType = activity.deviceType || 'Unknown';
                const moodEmoji = activity.moodEmoji || '';
                const mood = activity.mood || '';
                const note = (activity.note || '').replace(/"/g, '""'); // Escape quotes
                
                csv += `${start.toLocaleDateString()},${start.toLocaleTimeString()},${end.toLocaleTimeString()},${durationMin},"${tagPath}",${tagId},${activity.app},${device},${deviceType},${moodEmoji},${mood},"${note}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `activity-tracker-${deviceName}-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Data Import
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    
                    // Skip header
                    const dataLines = lines.slice(1).filter(line => line.trim());
                    
                    let imported = 0;
                    let duplicates = 0;
                    
                    dataLines.forEach(line => {
                        // Parse CSV line (handle quoted fields)
                        const parts = [];
                        let current = '';
                        let inQuotes = false;
                        
                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                parts.push(current);
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        parts.push(current);
                        
                        if (parts.length < 6) return;
                        
                        const [dateStr, startTimeStr, endTimeStr, durationStr, tagPath, tagId, app, device, deviceType, moodEmoji, mood, note] = parts;
                        
                        // Reconstruct start and end times
                        const startDateTime = new Date(`${dateStr} ${startTimeStr}`);
                        const endDateTime = new Date(`${dateStr} ${endTimeStr}`);
                        
                        // Check for duplicates (same start time, tag, app, and device)
                        const isDuplicate = allActivities.some(a => 
                            new Date(a.start).getTime() === startDateTime.getTime() &&
                            a.app === app &&
                            (a.tagFullPath || a.tag) === tagPath &&
                            (a.device || '') === (device || '')
                        );
                        
                        if (isDuplicate) {
                            duplicates++;
                            return;
                        }
                        
                        // Find tag color
                        let tagColor = '#667eea';
                        if (tagId) {
                            const tag = getTagById(tagId);
                            if (tag) tagColor = tag.color;
                        }
                        
                        const activity = {
                            tagId: tagId || '',
                            tag: tagPath.split(' ‚Ä∫ ').pop(),
                            tagFullPath: tagPath,
                            tagColor: tagColor,
                            app: app,
                            device: device || 'Unknown',
                            deviceType: deviceType || device || 'Unknown',
                            start: startDateTime.toISOString(),
                            end: endDateTime.toISOString(),
                            duration: endDateTime - startDateTime,
                            moodEmoji: moodEmoji || null,
                            mood: mood || null,
                            note: note || ''
                        };
                        
                        allActivities.push(activity);
                        imported++;
                    });
                    
                    // Sort activities by date
                    allActivities.sort((a, b) => new Date(a.start) - new Date(b.start));
                    
                    saveData();
                    renderCurrentView();
                    
                    // Show status
                    const status = document.getElementById('importStatus');
                    status.style.display = 'block';
                    status.style.background = '#d1fae5';
                    status.style.color = '#065f46';
                    status.innerHTML = `
                        <strong>‚úì Import Complete!</strong><br>
                        ${imported} activities imported from other devices<br>
                        ${duplicates} duplicates skipped<br>
                        Total activities: ${allActivities.length}
                    `;
                    
                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 5000);
                    
                } catch (error) {
                    console.error('Import error:', error);
                    const status = document.getElementById('importStatus');
                    status.style.display = 'block';
                    status.style.background = '#fee2e2';
                    status.style.color = '#991b1b';
                    status.innerHTML = `<strong>‚úó Import Failed</strong><br>Error: ${error.message}`;
                }
            };
            
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Tag Manager Modal
        function openTagManager() {
            renderColorPicker();
            renderTagsManager();
            document.getElementById('tagModal').classList.add('active');
        }

        function closeTagManager() {
            document.getElementById('tagModal').classList.remove('active');
            document.getElementById('newTagName').value = '';
        }

        function renderColorPicker() {
            const picker = document.getElementById('colorPicker');
            picker.innerHTML = colorOptions.map(color => 
                `<div class="color-option ${color === selectedColor ? 'selected' : ''}" 
                      style="background: ${color};" 
                      onclick="selectColor('${color}')"></div>`
            ).join('');
        }

        function selectColor(color) {
            selectedColor = color;
            renderColorPicker();
        }

        function addNewTag() {
            const name = document.getElementById('newTagName').value.trim();
            if (!name) {
                alert('Please enter a tag name!');
                return;
            }

            const currentTags = getCurrentTags();
            if (currentTags.some(t => t.name.toLowerCase() === name.toLowerCase())) {
                alert('This tag already exists!');
                return;
            }

            const newTag = {
                id: String(nextTagId++),
                name,
                color: selectedColor,
                children: []
            };

            if (selectedTagPath.length === 0) {
                tags.push(newTag);
            } else {
                const parentId = selectedTagPath[selectedTagPath.length - 1];
                const parent = getTagById(parentId);
                if (parent) {
                    if (!parent.children) parent.children = [];
                    parent.children.push(newTag);
                }
            }

            saveData();
            renderTagHierarchy();
            renderTagsManager();
            document.getElementById('newTagName').value = '';
        }

        function renderTagsManager() {
            const list = document.getElementById('tagsList');
            
            function renderTagTree(tagList, level = 0) {
                return tagList.map(tag => `
                    <div style="margin-left: ${level * 20}px;">
                        <div class="tag-manager-item">
                            <div class="tag-manager-item-content">
                                <div style="width: 20px; height: 20px; background: ${tag.color}; border-radius: 50%;"></div>
                                <span>${tag.name}</span>
                            </div>
                            <div class="tag-actions">
                                <button class="add-child-btn" onclick="addChildToTag('${tag.id}')">+ Sub</button>
                                ${(!tag.children || tag.children.length === 0) ? `<button class="delete-btn" onclick="deleteTag('${tag.id}')">Delete</button>` : ''}
                            </div>
                        </div>
                        ${tag.children && tag.children.length > 0 ? renderTagTree(tag.children, level + 1) : ''}
                    </div>
                `).join('');
            }
            
            list.innerHTML = renderTagTree(tags);
        }

        function addChildToTag(parentId) {
            selectedTagPath = getTagFullPath(parentId).map(t => t.id);
            document.getElementById('newTagName').focus();
        }

        function deleteTag(tagId) {
            const tag = getTagById(tagId);
            if (!tag) return;

            if (confirm(`Delete tag "${tag.name}"?`)) {
                function removeFromList(tagList) {
                    const index = tagList.findIndex(t => t.id === tagId);
                    if (index !== -1) {
                        tagList.splice(index, 1);
                        return true;
                    }
                    for (const t of tagList) {
                        if (t.children && removeFromList(t.children)) {
                            return true;
                        }
                    }
                    return false;
                }

                removeFromList(tags);
                saveData();
                renderTagHierarchy();
                renderTagsManager();
            }
        }

        // Pie Chart Detail Modal Functions
        function showPieDetail(title, content) {
            document.getElementById('pieDetailTitle').textContent = title;
            document.getElementById('pieDetailContent').innerHTML = content;
            document.getElementById('pieDetailModal').classList.add('active');
        }

        function closePieDetail() {
            document.getElementById('pieDetailModal').classList.remove('active');
        }

        // Date Comparison Functions
        function openDateCompare() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            document.getElementById('compareDate1').value = yesterday.toISOString().split('T')[0];
            document.getElementById('compareDate2').value = today.toISOString().split('T')[0];
            
            document.getElementById('dateCompareModal').classList.add('active');
            updateComparison();
        }

        function closeDateCompare() {
            document.getElementById('dateCompareModal').classList.remove('active');
        }

        function updateComparison() {
            const date1Str = document.getElementById('compareDate1').value;
            const date2Str = document.getElementById('compareDate2').value;
            
            if (!date1Str || !date2Str) return;
            
            const date1 = new Date(date1Str);
            const date2 = new Date(date2Str);
            
            const activities1 = allActivities.filter(a => {
                const actDate = new Date(a.start);
                return actDate.toDateString() === date1.toDateString();
            }).filter(a => a.mood && a.moodEmoji);
            
            const activities2 = allActivities.filter(a => {
                const actDate = new Date(a.start);
                return actDate.toDateString() === date2.toDateString();
            }).filter(a => a.mood && a.moodEmoji);
            
            const container = document.getElementById('comparisonCharts');
            
            if (activities1.length === 0 && activities2.length === 0) {
                container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">No mood data for selected dates</div>';
                return;
            }
            
            const moodEmojis = {
                'Happy': 'üòä', 'Calm': 'üòå', 'Focused': 'ü§î', 'Tired': 'üò´',
                'Frustrated': 'üò§', 'Excited': 'üòÑ', 'Neutral': 'üòê', 'Productive': 'üí™',
                'Stressed': 'üò©', 'Bored': 'ü•±', 'Confident': 'üòé', 'Satisfied': 'ü§ó',
                'Anxious': 'üò∞', 'Content': 'üôÇ', 'Relieved': 'üòÆ‚Äçüí®'
            };
            
            container.innerHTML = `
                <div>
                    <h3 style="text-align: center; margin-bottom: 15px;">${date1.toLocaleDateString()}</h3>
                    ${generateComparisonChart(activities1, moodEmojis)}
                </div>
                <div>
                    <h3 style="text-align: center; margin-bottom: 15px;">${date2.toLocaleDateString()}</h3>
                    ${generateComparisonChart(activities2, moodEmojis)}
                </div>
            `;
        }

        function generateComparisonChart(activities, moodEmojis) {
            if (activities.length === 0) {
                return '<div style="text-align: center; padding: 40px; color: #999;">No data</div>';
            }
            
            const moodStats = {};
            activities.forEach(a => {
                moodStats[a.mood] = (moodStats[a.mood] || 0) + a.duration;
            });
            
            const totalTime = Object.values(moodStats).reduce((sum, val) => sum + val, 0);
            const moodColors = getMoodColors();
            
            let html = '<div style="background: #f8f9fa; padding: 15px; border-radius: 12px;">';
            
            // Summary
            const hours = Math.floor(totalTime / 3600000);
            const minutes = Math.floor((totalTime % 3600000) / 60000);
            html += `<p style="text-align: center; margin-bottom: 15px; font-weight: 600;">Total: ${hours}h ${minutes}m</p>`;
            
            // Bar chart
            Object.entries(moodStats)
                .sort((a, b) => b[1] - a[1])
                .forEach(([mood, ms]) => {
                    const moodHours = Math.floor(ms / 3600000);
                    const moodMinutes = Math.floor((ms % 3600000) / 60000);
                    const percentage = (ms / totalTime * 100);
                    const color = moodColors[mood] || '#C9ADA7';
                    const emoji = moodEmojis[mood] || 'üòä';
                    
                    html += `
                        <div style="margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.9em;">
                                <span>${emoji} ${mood}</span>
                                <span>${moodHours}h ${moodMinutes}m</span>
                            </div>
                            <div style="height: 24px; background: #e0e0e0; border-radius: 8px; overflow: hidden;">
                                <div style="height: 100%; background: ${color}; width: ${percentage}%; display: flex; align-items: center; padding: 0 8px; color: white; font-size: 0.8em; font-weight: 600;">
                                    ${percentage > 15 ? Math.round(percentage) + '%' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
            
            html += '</div>';
            return html;
        }

        // Color Customization Functions
        function openColorCustom() {
            const container = document.getElementById('moodColorCustomizer');
            const moodColors = getMoodColors();
            const moodEmojis = {
                'Happy': 'üòä', 'Calm': 'üòå', 'Focused': 'ü§î', 'Tired': 'üò´',
                'Frustrated': 'üò§', 'Excited': 'üòÑ', 'Neutral': 'üòê', 'Productive': 'üí™',
                'Stressed': 'üò©', 'Bored': 'ü•±', 'Confident': 'üòé', 'Satisfied': 'ü§ó',
                'Anxious': 'üò∞', 'Content': 'üôÇ', 'Relieved': 'üòÆ‚Äçüí®'
            };
            
            let html = '';
            Object.entries(moodColors).forEach(([mood, color]) => {
                const emoji = moodEmojis[mood] || 'üòä';
                html += `
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                        <span style="font-size: 1.5em;">${emoji}</span>
                        <span style="flex: 1; font-weight: 600;">${mood}</span>
                        <input type="color" value="${color}" id="color-${mood}" style="width: 60px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('colorCustomModal').classList.add('active');
        }

        function closeColorCustom() {
            document.getElementById('colorCustomModal').classList.remove('active');
        }

        function saveColorCustomization() {
            const newColors = {};
            const moodColors = getMoodColors();
            
            Object.keys(moodColors).forEach(mood => {
                const input = document.getElementById(`color-${mood}`);
                if (input) {
                    newColors[mood] = input.value;
                }
            });
            
            customMoodColors = newColors;
            localStorage.setItem('customMoodColors', JSON.stringify(customMoodColors));
            
            alert('‚úì Colors saved! Charts will update with your custom colors.');
            closeColorCustom();
            
            // Refresh current view
            renderCurrentView();
        }

        function resetColors() {
            if (confirm('Reset all mood colors to default?')) {
                customMoodColors = null;
                localStorage.removeItem('customMoodColors');
                openColorCustom(); // Refresh the modal
                renderCurrentView();
            }
        }

        // Export Pie Chart Function
        function exportPieChart() {
            alert('üíæ Chart Export Feature\n\nTo export charts:\n\n1. Take a screenshot (Cmd/Ctrl + Shift + 4 on Mac)\n2. Or use browser\'s built-in screenshot tool\n3. Or right-click on chart ‚Üí "Save image as..."\n\nFor higher quality exports, consider using a dedicated screenshot tool like:\n- Mac: Cmd + Shift + 4\n- Windows: Snipping Tool\n- Browser: DevTools ‚Üí Capture screenshot');
        }

        // Initialize
        init();
    </script>
</body>
</html>